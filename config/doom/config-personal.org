#+title: Emacs Config: Personal
#+author: Cash Weaver
#+email: cashbweaver@gmail.com

This is my Emacs configuration file; written in [[https://orgmode.org][=org-mode=]] in literate programming style and based heavily on the work of others[fn:1].

* General
** User Information

#+begin_src emacs-lisp :tangle config-personal.el
(setq
 user-full-name "Cash Weaver"
 user-mail-address "cashbweaver@gmail.com")
#+end_src

** Date and Time

#+begin_src emacs-lisp :tangle config-personal.el
(setq
 ;; Use YYYY-MM-DD date format.
 calendar-date-style 'iso)
#+end_src

*** Helper Functions

#+begin_src emacs-lisp :tangle config-personal.el
(defun cashweaver/format-time (&optional time-format offset-days)
  "Return the (offset) date in format."
  (interactive)
  (let* ((time-format
         (or time-format
             "%Y-%m-%d"))
        (offset-days
         (if offset-days
             offset-days
           0))
        (time
         (cond
          ((= offset-days
              0)
           (current-time))
          (t
           (time-add
            (current-time)
            (days-to-time offset-days))))))
    (format-time-string
     time-format
     time)))

(defun cashweaver/todays-date ()
  "Return todays date as YYYY-MM-DD."
  (cashweaver/format-time
   "%Y-%m-%d"
   ;; offset-days
   0))

(defun cashweaver/yesterdays-date ()
  "Return yesterday's date as YYYY-MM-DD."
  (cashweaver/format-time
   "%Y-%m-%d"
   ;; offset-days
   -1))
#+end_src

** Packages
*** =free-keys=

Show free bindings in current buffer.

**** Package
#+begin_src emacs-lisp :tangle packages-personal.el
(package! free-keys
  :recipe (:host github
           :repo "Fuco1/free-keys"))
#+end_src

**** Config

#+begin_src emacs-lisp :tangle config-personal.el
(use-package! free-keys)
#+end_src

*** =command-log-mode=

For showing which keys I'm pressing during screencasts, presentations, or pairing sessions.

Alternatives include:

- [[https://gitlab.com/screenkey/screenkey][screenkey]]: "A screencast tool to display your keys inspired by Screenflick"

**** Package

#+begin_src emacs-lisp :tangle packages-personal.el
(package! command-log-mode)
#+end_src

**** Config

#+begin_src emacs-lisp :tangle config-personal.el
(use-package! command-log-mode
  :config
  (setq
   command-log-mode-open-log-turns-on-mode t
   command-log-mode-window-size 80
   command-log-mode-is-global t))
#+end_src

**** Usage

#+begin_src emacs-lisp
;; Enable the global mode
(global-command-log-mode)

;; Toggle the log buffer
(clm/toggle-command-log-buffer)
#+end_src
** TODO Notifications

*** =alert=
**** Package

Doom Emacs provides =alert=.

**** Config

#+begin_src emacs-lisp :tangle config-personal.el
(setq
 alert-fade-time 60
 alert-default-style 'libnotify)
#+end_src

*** =org-wild-notifier=
**** Package

#+begin_src emacs-lisp :tangle packages-personal.el
(package! org-wild-notifier)
#+end_src

**** Config

#+begin_src emacs-lisp :tangle config-personal.el
;; Too early load error
(use-package! org-wild-notifier
  :config
  (setq
   org-wild-notifier-alert-time '(2))
  (org-wild-notifier-mode))
#+end_src

** Keybindings
*** Helper Methods

#+begin_src emacs-lisp :tangle config-personal.el
; Reference; https://www.emacswiki.org/emacs/DocumentingKeyBindingToLambda
(defun evil-lambda-key (mode keymap key def)
  "Wrap `evil-define-key' to provide documentation."
  (set 'sym (make-symbol (documentation def)))
  (fset sym def)
  (evil-define-key mode keymap key sym))
#+end_src

*** General / Global

#+begin_src emacs-lisp :tangle config-personal.el
(map!
 ;; Keep in alphabetical order.
 (:leader
  :desc "at point" :n "h h" #'helpful-at-point
  :desc "Langtool" :n "t L" #'langtool-check
  (:prefix ("n")
   :desc "Store email link" :n "L" #'org-notmuch-store-link
   (:prefix ("A" . "Anki")
    :n "d" #'anki-editor-delete-notes
    :n "c" #'anki-editor-cloze-dwim
    :n "i" #'anki-editor-insert-note)
   (:prefix ("r")
    :n "C" #'cashweaver/org-roam-node-from-cite))
  (:prefix ("p")
   :n "u" #'cashweaver/projectile-refresh-known-paths)
  (:prefix ("t")
   :n "k" #'clm/toggle-command-log-buffer)))

(map!
 ;; Keep in alphabetical order.
 :map global-map
 "M-N" #'operate-on-number-at-point
 :v "C-r" #'cashweaver/replace-selection
 (:prefix ("z")
  :n "O" #'evil-open-fold-rec))
#+end_src

** Emacs


#+begin_src emacs-lisp :tangle config-personal.el
(setq
 ;; Avoid frequent garbage collection by setting a high threshold.
 gc-cons-threshold (math-pow 10 8))
#+end_src

* Doom Emacs
I use [[github:hlissner/doom-emacs][Doom Emacs]] as the base for my configuration to save time and get to coding faster than I would if I had to roll an entire configuration from scratch.

** Configuration File headers

The base configuration files (=init.el=, =config.el=, and =packages.el=) include a bit of boilerplate when you first create them using =doom install=. I like to preserve this boilerplate.

#+HTMl: <details><summary>init.el</summary>
#+attr_html: :collapsed t
#+begin_src emacs-lisp :tangle init.el
;;; init.el -*- lexical-binding: t; -*-

;; DO NOT EDIT THIS FILE MANUALLY.
;; This file is generated from doom.md. You should make your changes there and
;; this file using org-babel-tangle.

;; This file controls what Doom modules are enabled and what order they load
;; in. Remember to run 'doom sync' after modifying it!

;; NOTE Press 'SPC h d h' (or 'C-h d h' for non-vim users) to access Doom's
;;      documentation. There you'll find a "Module Index" link where you'll find
;;      a comprehensive list of Doom's modules and what flags they support.

;; NOTE Move your cursor over a module's name (or its flags) and press 'K' (or
;;      'C-c c k' for non-vim users) to view its documentation. This works on
;;      flags as well (those symbols that start with a plus).
;;
;;      Alternatively, press 'gd' (or 'C-c c d') on a module to browse its
;;      directory (for easy access to its source code).
#+end_src
#+HTMl: </details>

#+HTMl: <details><summary>packages-personal.el</summary>
#+attr_html: :collapsed t
#+begin_src emacs-lisp :tangle packages-personal.el
;; -*- no-byte-compile: t; -*-
;;; $DOOMDIR/packages-personal.el

;; DO NOT EDIT THIS FILE MANUALLY.
;; This file is generated from doom.md. You should make your changes there and
;; this file using org-babel-tangle.

;; To install a package with Doom you must declare them here and run 'doom sync'
;; on the command line, then restart Emacs for the changes to take effect -- or
;; use 'M-x doom/reload'.


;; To install SOME-PACKAGE from MELPA, ELPA or emacsmirror:
;(package! some-package)

;; To install a package directly from a remote git repo, you must specify a
;; `:recipe'. You'll find documentation on what `:recipe' accepts here:
;; https://github.com/raxod502/straight.el#the-recipe-format
;(package! another-package
;  :recipe (:host github :repo "username/repo"))

;; If the package you are trying to install does not contain a PACKAGENAME.el
;; file, or is located in a subdirectory of the repo, you'll need to specify
;; `:files' in the `:recipe':
;(package! this-package
;  :recipe (:host github :repo "username/repo"
;           :files ("some-file.el" "src/lisp/*.el")))

;; If you'd like to disable a package included with Doom, you can do so here
;; with the `:disable' property:
;(package! builtin-package :disable t)

;; You can override the recipe of a built in package without having to specify
;; all the properties for `:recipe'. These will inherit the rest of its recipe
;; from Doom or MELPA/ELPA/Emacsmirror:
;(package! builtin-package :recipe (:nonrecursive t))
;(package! builtin-package-2 :recipe (:repo "myfork/package"))

;; Specify a `:branch' to install a package from a particular branch or tag.
;; This is required for some packages whose default branch isn't 'master' (which
;; our package manager can't deal with; see raxod502/straight.el#279)
;(package! builtin-package :recipe (:branch "develop"))

;; Use `:pin' to specify a particular commit to install.
;(package! builtin-package :pin "1a2b3c4d5e")


;; Doom's packages are pinned to a specific commit and updated from release to
;; release. The `unpin!' macro allows you to unpin single packages...
;(unpin! pinned-package)
;; ...or multiple packages
;(unpin! pinned-package another-pinned-package)
;; ...Or *all* packages (NOT RECOMMENDED; will likely break things)
;(unpin! t)
#+end_src
#+HTMl: </details>

#+HTMl: <details><summary>config-personal.el</summary>
#+attr_html: :collapsed t
#+begin_src emacs-lisp :tangle config-personal.el
;;; $DOOMDIR/config-personal.el -*- lexical-binding: t; -*-

;; DO NOT EDIT THIS FILE MANUALLY.
;; This file is generated from doom.md. You should make your changes there and
;; this file using org-babel-tangle.

;; Place your private configuration here! Remember, you do not need to run 'doom
;; sync' after modifying this file!


;; Some functionality uses this to identify you, e.g. GPG configuration, email
;; clients, file templates and snippets.
; (setq user-full-name "John Doe"
;       user-mail-address "john@doe.com")

;; Doom exposes five (optional) variables for controlling fonts in Doom. Here
;; are the three important ones:
;;
;; + `doom-font'
;; + `doom-variable-pitch-font'
;; + `doom-big-font' -- used for `doom-big-font-mode'; use this for
;;   presentations or streaming.
;;
;; They all accept either a font-spec, font string ("Input Mono-12"), or xlfd
;; font string. You generally only need these two:
;; (setq doom-font (font-spec :family "monospace" :size 12 :weight 'semi-light)
;;       doom-variable-pitch-font (font-spec :family "sans" :size 13))

;; There are two ways to load a theme. Both assume the theme is installed and
;; available. You can either set `doom-theme' or manually load a theme with the
;; `load-theme' function. This is the default:
; (setq doom-theme 'doom-one)

;; If you use `org' and don't want your org files in the default location below,
;; change `org-directory'. It must be set before org loads!
; (setq org-directory "~/org/")

;; This determines the style of line numbers in effect. If set to `nil', line
;; numbers are disabled. For relative line numbers, set this to `relative'.
; (setq display-line-numbers-type t)


;; Here are some additional functions/macros that could help you configure Doom:
;;
;; - `load!' for loading external *.el files relative to this one
;; - `use-package!' for configuring packages
;; - `after!' for running code after a package has loaded
;; - `add-load-path!' for adding directories to the `load-path', relative to
;;   this file. Emacs searches the `load-path' when you load packages with
;;   `require' or `use-package'.
;; - `map!' for binding new keys
;;
;; To get information about any of these functions/macros, move the cursor over
;; the highlighted symbol at press 'K' (non-evil users must press 'C-c c k').
;; This will open documentation for it, including demos of how they are used.
;;
;; You can also try 'gd' (or 'C-c c d') to jump to their definition and see how
;; they are implemented.
#+end_src
#+HTMl: </details>

** =init.el=

#+HTMl: <details><summary>init.el</summary>
#+attr_html: :collapsed t
#+begin_src emacs-lisp :tangle init.el :noweb no-export
(doom!
 :input
 <<doom-input>>

 :completion
 <<doom-completion>>

 :ui
 <<doom-ui>>

 :editor
 <<doom-editor>>

 :emacs
 <<doom-emacs>>

 :term
 <<doom-term>>

 :checkers
 <<doom-checkers>>

 :tools
 <<doom-tools>>

 :os
 <<doom-os>>

 :lang
 <<doom-lang>>

 :email
 <<doom-email>>

 :app
 <<doom-app>>

 :config
 <<doom-config>>
 )
#+end_src
#+HTMl: </details>

#+HTMl: <details><summary>doom-input</summary>
#+name: doom-input
#+begin_src emacs-lisp
;;chinese
;;japanese
;;layout            ; auie,ctsrnm is the superior home row
#+end_src
#+HTMl: </details>

#+HTMl: <details><summary>doom-completion</summary>
#+name: doom-completion
#+begin_src emacs-lisp
company           ; the ultimate code completion backend
;;helm              ; the *other* search engine for love and life
;;ido               ; the other *other* search engine...
;;ivy               ; a search engine for love and life
vertico           ; the search engine of the future
#+end_src
#+HTMl: </details>

#+HTMl: <details><summary>doom-ui</summary>
#+name: doom-ui
#+begin_src emacs-lisp
;;deft              ; notational velocity for Emacs
doom                ; what makes DOOM look the way it does
doom-dashboard      ; a nifty splash screen for Emacs
doom-quit           ; DOOM quit-message prompts when you quit Emacs
(emoji              ; 🙂
 +ascii
 +github
 +unicode)
hl-todo             ; highlight TODO/FIXME/NOTE/DEPRECATED/HACK/REVIEW
;;hydra
;;indent-guides     ; highlighted indent columns
;;ligatures         ; ligatures and symbols to make your code pretty again
;;minimap           ; show a map of the code on the side
modeline            ; snazzy, Atom-inspired modeline, plus API
;;nav-flash         ; blink cursor line after big motions
;;neotree           ; a project drawer, like NERDTree for vim
ophints             ; highlight the region an operation acts on
(popup +defaults)   ; tame sudden yet inevitable temporary windows
;;tabs              ; a tab bar for Emacs
;;treemacs          ; a project drawer, like neotree but cooler
unicode             ; extended unicode support for various languages
vc-gutter           ; vcs diff in the fringe
vi-tilde-fringe     ; fringe tildes to mark beyond EOB
;;window-select     ; visually switch windows
workspaces          ; tab emulation, persistence & separate workspaces
zen               ; distraction-free coding or writing
#+end_src
#+HTMl: </details>

#+HTMl: <details><summary>doom-editor</summary>
#+name: doom-editor
#+begin_src emacs-lisp
(evil +everywhere)  ; come to the dark side, we have cookies
file-templates      ; auto-snippets for empty files
fold                ; (nigh) universal code folding
;;(format +onsave)  ; automated prettiness
;;god               ; run Emacs commands without modifier keys
lispy             ; vim for lisp, for people who don't like vim
;;multiple-cursors  ; editing in many places at once
;;objed             ; text object editing for the innocent
;;parinfer          ; turn lisp into python, sort of
;;rotate-text       ; cycle region at point between text candidates
snippets            ; my elves. They type so I don't have to
word-wrap           ; soft wrapping with language-aware indent
#+end_src
#+HTMl: </details>

#+HTMl: <details><summary>doom-emacs</summary>
#+name: doom-emacs
#+begin_src emacs-lisp
dired               ; making dired pretty [functional]
electric            ; smarter, keyword-based electric-indent
;;ibuffer           ; interactive buffer management
undo                ; persistent, smarter undo for your inevitable mistakes
vc                  ; version-control and Emacs, sitting in a tree
#+end_src
#+HTMl: </details>

#+HTMl: <details><summary>doom-term</summary>
#+name: doom-term
#+begin_src emacs-lisp
;;eshell            ; the elisp shell that works everywhere
;;shell             ; simple shell REPL for Emacs
;;term              ; basic terminal emulator for Emacs
vterm               ; the best terminal emulation in Emacs
#+end_src
#+HTMl: </details>

#+HTMl: <details><summary>doom-checkers</summary>
#+name: doom-checkers
#+begin_src emacs-lisp
;; tasing you for every semicolon you forget
syntax
;; tasing you for misspelling mispelling
(spell
 +flyspell
 +everywhere)
;; tasing grammar mistake every you make
grammar
#+end_src
#+HTMl: </details>

#+HTMl: <details><summary>doom-tools</summary>
#+name: doom-tools
#+begin_src emacs-lisp
;;ansible
biblio            ; Writes a PhD for you (citation needed)
;;debugger          ; FIXME stepping through code, to help you add bugs
;;direnv
;;docker
;;editorconfig      ; let someone else argue about tabs vs spaces
;;ein               ; tame Jupyter notebooks with emacs
(eval +overlay)     ; run code, run (also, repls)
;;gist              ; interacting with github gists
lookup              ; navigate your code and its documentation
;;lsp               ; M-x vscode
magit             ; a git porcelain for Emacs
;;make              ; run make tasks from Emacs
;;pass              ; password manager for nerds
pdf               ; pdf enhancements
;;prodigy           ; FIXME managing external services & code builders
rgb               ; creating color strings
;;taskrunner        ; taskrunner for all your projects
;;terraform         ; infrastructure as code
;;tmux              ; an API for interacting with tmux
;;upload            ; map local to remote projects via ssh/ftp
#+end_src
#+HTMl: </details>

#+HTMl: <details><summary>doom-os</summary>
#+name: doom-os
#+begin_src emacs-lisp
(:if IS-MAC macos)  ; improve compatibility with macOS
;;tty               ; improve the terminal Emacs experience
#+end_src
#+HTMl: </details>

#+HTMl: <details><summary>doom-lang</summary>
#+name: doom-lang
#+begin_src emacs-lisp
;;agda              ; types of types of types of types...
;;cc                ; C/C++/Obj-C madness
;;clojure           ; java with a lisp
;;common-lisp       ; if you've seen one lisp, you've seen them all
;;coq               ; proofs-as-programs
;;crystal           ; ruby at the speed of c
;;csharp            ; unity, .NET, and mono shenanigans
;;data              ; config/data formats
;;(dart +flutter)   ; paint ui and not much else
;;elixir            ; erlang done right
;;elm               ; care for a cup of TEA?
emacs-lisp          ; drown in parentheses
;;erlang            ; an elegant language for a more civilized age
;;ess               ; emacs speaks statistics
;;faust             ; dsp, but you get to keep your soul
;;fsharp            ; ML stands for Microsoft's Language
;;fstar             ; (dependent) types and (monadic) effects and Z3
;;gdscript          ; the language you waited for
;;(go +lsp)         ; the hipster dialect
;;(haskell +dante)  ; a language that's lazier than I am
;;hy                ; readability of scheme w/ speed of python
;;idris             ; a language you can depend on
;;json              ; At least it ain't XML
java                                        ; the poster child for carpal tunnel syndrome
javascript
;;julia             ; a better, faster MATLAB
;;kotlin            ; a better, slicker Java(Script)
;;latex             ; writing papers in Emacs has never been so fun
;;lean
;;factor
;;ledger            ; an accounting system in Emacs
;;lua               ; one-based indices? one-based indices
markdown            ; writing docs for people to ignore
;;nim               ; python + lisp at the speed of c
;;nix               ; I hereby declare "nix geht mehr!"
;;ocaml             ; an objective camel
(org                ; organize your plain life in plain text
 ;; Use custom hugo depending on personal vs work environment
 ;; +hugo
 +noter
 +pretty
 +roam2
 +pandoc
 +pomodoro)
;;php               ; perl's insecure younger brother
;;plantuml          ; diagrams for confusing people more
;;purescript        ; javascript, but functional
python
;;qt                ; the 'cutest' gui framework ever
;;racket            ; a DSL for DSLs
;;raku              ; the artist formerly known as perl6
;;rest              ; Emacs as a REST client
;;rst               ; ReST in peace
;;(ruby +rails)     ; 1.step {|i| p "Ruby is #{i.even? ? 'love' : 'life'}"}
;;rust              ; Fe2O3.unwrap().unwrap().unwrap().unwrap()
;;scala             ; java, but good
;;scheme            ; a fully conniving family of lisps
sh                  ; she sells {ba,z,fi}sh shells on the C xor
;;sml
;;solidity          ; do you need a blockchain? No.
;;swift             ; who asked for emoji variables?
;;terra             ; Earth and Moon in alignment for performance.
;;web               ; the tubes
yaml                ; JSON, but readable
#+end_src
#+HTMl: </details>

#+HTMl: <details><summary>doom-email</summary>
#+name: doom-email
#+begin_src emacs-lisp
;;(mu4e +gmail)
notmuch
;;(wanderlust +gmail)
#+end_src
#+HTMl: </details>

#+HTMl: <details><summary>doom-app</summary>
#+name: doom-app
#+begin_src emacs-lisp
;;calendar
;;emms
everywhere
;;irc               ; how neckbeards socialize
;;(rss +org)        ; emacs as an RSS reader
;;twitter           ; twitter client https://twitter.com/vnought
#+end_src
#+HTMl: </details>

#+HTMl: <details><summary>doom-config</summary>
#+name: doom-config
#+begin_src emacs-lisp
;;literate
(default +bindings +smartparens)
#+end_src
#+HTMl: </details>
* Appearance

#+begin_src emacs-lisp :tangle config-personal.el
(setq
 doom-theme 'doom-tomorrow-night
 show-trailing-whitespace t)
#+end_src

** =svg-tag-mode=

*** Package

#+begin_src emacs-lisp :tangle packages-personal.el
(package! svg-tag-mode)
#+end_src

*** Config

#+begin_src emacs-lisp :tangle config-personal.el
(use-package! svg-tag-mode
  :config
  (setq
   svg-tag-tags '(("\\(:[A-Z]+:\\)" . ((lambda (tag) (svg-tag-make tag :beg 1 :end -1)))))))
#+end_src

* Applications
** Mail
*** Packges
**** =gnus-alias=
***** Package

#+begin_src emacs-lisp :tangle packages-personal.el
(package! gnus-alias)
#+end_src

***** Config

#+begin_src emacs-lisp :tangle config-personal.el
(use-package! gnus-alias
  :config
  (autoload 'gnus-alias-determine-identity "gnus-alias" "" t)
  (gnus-alias-init))
#+end_src
****** TODO Work :work:

#+begin_src emacs-lisp :tangle config-personal.el
(after! gnus-alias
  (setq
   gnus-alias-identity-alist '(("work"
                                ;; Refers to
                                nil
                                "Cash Weaver <cashweaver@google.com>"
                                ;; Organization
                                nil
                                ;; Extra headers
                                nil
                                ;; Body
                                nil "~/.email_signature"))
   gnus-alias-default-identity "work"))
#+end_src

**** =notmuch=
***** Package

Doom emacs provides =notmuch= through =init.el=.

***** Config

#+begin_src emacs-lisp :tangle config-personal.el
(defun cashweaver/notmuch-show-open-or-close-all ()
  "Toggle between showing and hiding all messages in the thread."
  (interactive))

(defun cashweaver/notmuch--search-thread-has-tag-p (match-tag)
  "Whether or not the thread has a tag."
  (interactive)
  (let ((thread-tags (notmuch-search-get-tags)))
    (member match-tag thread-tags)))

(defun cashweaver/notmuch-search-toggle-tag (tag)
  "Toggle the provided tag."
  (interactive)
  (if (member tag (notmuch-search-get-tags))
      (notmuch-search-tag (list (concat "-" tag)))
    (notmuch-search-tag (list (concat "+" tag)))))

(defun cashweaver/notmuch--search-thread-toggle-tag (key)
  "Toggle the specified tag(s)."
  (interactive "k")
  (let ((tags (assoc key cashweaver/notmuch-tag-alist)))
    (apply 'notmuch-search-tag (cdr tags))))

(defun cashweaver/notmuch-search-super-archive (&optional beg end)
  "Super archive the selected thread; based on `notmuch-search-archive-thread'."
  (interactive (notmuch-interactive-region))
  (notmuch-search-tag
   cashweaver/notmuch-super-archive-tags
   beg
   end)
  (when (eq beg
            end)
    (notmuch-search-next-thread)))

(defun cashweaver/notmuch-search-follow-up ()
  "Capture the email at point in search for following up."
  (interactive)
  (notmuch-search-show-thread)
  (goto-char
   (point-max))
  (org-capture
   ;; goto
   nil
   ;; keys
   "tef"))

(defun cashweaver/org-notmuch-capture-follow-up-mail ()
  "Capture mail to org mode."
  (interactive)
  (org-store-link nil)
  (org-capture nil "ef"))

(defun cashweaver/notmuch--tag-search (key tag &optional query)
  "TODO."
  `(:key ,key
    :name ,tag
    :query ,(format "tag:inbox AND -tag:trash AND tag:%s%s"
                    tag
                    (if query
                        (concat " AND %s"
                                query)
                      ""))))

(after! notmuch
  (setq
   notmuch-wash-wrap-lines-length 100
   notmuch-saved-searches `(
                            ,(cashweaver/notmuch--tag-search "a" "attn")
                            ,(cashweaver/notmuch--tag-search "c" "calendar")
                            ,(cashweaver/notmuch--tag-search "d" "drive")
                            ;; Drafts
                            (:key "D"
                             :name "drafts"
                             :query "tag:draft")
                            ;; Inbox
                            (:key "i"
                             :name "inbox"
                             :query "tag:inbox AND -tag:trash")
                            (:key "I"
                             :name "Archive"
                             :query "-tag:inbox AND -tag:trash")
                            ,(cashweaver/notmuch--tag-search "r" "to-read")
                            ,(cashweaver/notmuch--tag-search "m" "to-me")
                            ,(cashweaver/notmuch--tag-search "M" "cc-me")
                            ;; Sent
                            (:key "s"
                             :name "sent"
                             :query "tag:sent")
                            ;; Waiting
                            (:key "w"
                             :name "waiting"
                             :query "tag:waiting")
                            )
   +notmuch-home-function (lambda ()
                            (notmuch-search "tag:inbox"))
   notmuch-archive-tags '("-inbox"
                          "-unread")
   notmuch-search-line-faces '(("attn" . '(:foreground "red3"))
                               ("waiting" . '(:foreground "orange3"))
                               ("calendar" . '(:foreground "DeepSkyBlue3"))
                               ("to-read" . '(:foreground "magenta3")))
   ;; Superset of `notmuch-archive-tags' for super archiving.
   cashweaver/notmuch-super-archive-tags (append
                                          notmuch-archive-tags
                                          '("-attn"
                                            "-waiting"
                                            "-to-read")))

  ;; Prevent wrapping at 70 characters in email composition.
  (add-hook! 'message-mode-hook 'turn-off-auto-fill)
  (add-hook! 'message-mode-hook 'visual-line-mode))
#+end_src

**** =org-msg=
***** Package

#+begin_src emacs-lisp :tangle packages-personal.el
(package! org-msg)
#+end_src

***** Config

#+begin_src emacs-lisp :tangle config-personal.el
;; (use-package! org-msg
;;   :config
;;   (setq
;;    org-msg-options "html-postamble:nil H:6 num:nil ^:{[ toc:nil author:nil email:nil \\n:t]}"
;;    org-msg-startup "hidestars indent inlineimages"
;;    org-msg-greeting-fmt "\nHi%s,\n\n"
;;    ;; org-msg-recipient-names
;;    org-msg-default-alternatives '((new . (text html))
;;                                   (reply-to-html . (text html))
;;                                   (reply-to-text . (text)))
;;    org-msg-convert-citation t
;;    ;; org-msg-signature is redundant -- use `gnus-alias-identity-alist'
;;    )
;;   (org-msg-mode))
#+end_src

*** Compose in =org-mode=

#+begin_src emacs-lisp :tangle config-personal.el
(defun cashweaver/compose-mail-org ()
  (interactive)
  (compose-mail)
  (message-goto-body)
  (setq *compose-html-org* t)
  (org-mode))

;; Deprecated in favor of org-mime `org-mime-edit-mail-in-org-mode'
(defun cashweaver/mail-toggle-org-message-mode ()
  (interactive)
  (if (derived-mode-p 'message-mode)
      (progn
        (setq *compose-html-org* t)
        (org-mode)
        (message "enabled org-mode"))
    (progn
      (setq *compose-html-org* nil)
      (notmuch-message-mode)
      (message "enabled notmuch-message-mode"))))

(defun cashweaver/mail-get-short-address (address)
  "Returns \"foo@\" for an ADDRESS of \"Foo <foo@bar.com>\"."
  (cond
   ((not (string-match "<" address))
    address)
   (t
    (replace-regexp-in-string
     ".*<\\(.*\\)@.*>"
     "\\1@"
     address))))

(defun cashweaver/mail-create-follow-up-todo ()
  (interactive)
  (let* ((file
          cashweaver/path--file--notes-todos)
         (to-short
          (cashweaver/mail-get-short-address
           (message-field-value "To")))
         (from-short
          (cashweaver/mail-get-short-address
           (message-field-value "From")))
         (subject
          (message-field-value "Subject"))
         (message-id
          (replace-regexp-in-string
           "<\\(.*\\)>"
           "\\1"
           (message-field-value "Message-ID")))
         (now
          (with-temp-buffer
            (org-mode)
            (org-time-stamp-inactive '(16))
            (buffer-substring-no-properties
             (point-min)
             (point-max)))))
    (with-current-buffer
        (get-file-buffer file)
      (goto-char
       (point-max))
      (org-insert-heading-respect-content)
      (org-todo "TODO")
      (insert
       (s-lex-format
        "[[notmuch:id:${message-id}][${subject} (${from-short} ➤ ${to-short})]]: Follow up :email:"
        ))
      (org-set-property
       "Created"
       now)
      (org-schedule
       nil))))

(defun cashweaver/message-send-and-exit ()
  (interactive)
  (org-mime-htmlize)
  (notmuch-mua-send)
  (if (y-or-n-p "Create follow-up TODO?")
      (cashweaver/mail-create-follow-up-todo))
  (kill-buffer
   (current-buffer)))
#+end_src

*** Custom =send-mail-function=

I need to use a different =send-mail-function= when sending email at work. I override =cashweaver/send-mail-function=, etc, in =config-work.el=.

#+begin_src emacs-lisp :tangle config-personal.el
(defun cashweaver/send-mail-function (&rest args)
  "Wrapper method for `send-mail-function' for easy overriding in work environment."
  (apply #'sendmail-query-once args))

(defun cashweaver/message-send-mail-function (&rest args)
  "Wrapper method for `message-send-mail-function' for easy overriding in work environment."
  (apply #'message--default-send-mail-function args))

(setq
 send-mail-function #'cashweaver/send-mail-function
 message-send-mail-function #'cashweaver/message-send-mail-function)
#+end_src
*** Keybindings

#+begin_src emacs-lisp :tangle config-personal.el
(after! notmuch
  ;; Keep in alphabetical order.
  (map!
   :map notmuch-message-mode-map
   "C-c C-c" #'cashweaver/message-send-and-exit)

  (map!
   :map notmuch-message-mode-map
   :localleader
   "e" #'org-mime-edit-mail-in-org-mode)

  (map!
   :map notmuch-show-mode-map
   "M-RET" #'cashweaver/notmuch-show-open-or-close-all)

  ;; Reply-all should be the default.
  (evil-define-key 'normal notmuch-show-mode-map "cr" 'notmuch-show-reply)
  (evil-define-key 'normal notmuch-show-mode-map "cR" 'notmuch-show-reply-sender)

  ;; Easy archive for my most-used tags.
  (evil-define-key 'normal notmuch-search-mode-map "A" 'notmuch-search-archive-thread)
  (evil-define-key 'normal notmuch-search-mode-map "a" 'cashweaver/notmuch-search-super-archive)
  (evil-define-key 'visual notmuch-search-mode-map "a" 'cashweaver/notmuch-search-super-archive)
  (evil-define-key 'normal notmuch-search-mode-map "f" 'cashweaver/notmuch-search-follow-up)

  ;; Unbind "t", and re-bind it to "T", so we can set it up as a prefix.
  (evil-define-key 'normal notmuch-search-mode-map "t" nil)
  (evil-define-key 'normal notmuch-search-mode-map "T" 'notmuch-search-filter-by-tag)

  ;; Helpers for toggling often-used tags.
  (evil-lambda-key 'normal notmuch-search-mode-map "t0" '(lambda ()
                                                           "Toggle p0"
                                                           (interactive)
                                                           (cashweaver/notmuch-search-toggle-tag "p0")))
  (evil-lambda-key 'normal notmuch-search-mode-map "tr" '(lambda ()
                                                           "Toggle Read!"
                                                           (interactive)
                                                           (cashweaver/notmuch-search-toggle-tag "Read!")))
  (evil-lambda-key 'normal notmuch-search-mode-map "tw" '(lambda ()
                                                           "Toggle waiting"
                                                           (interactive)
                                                           (cashweaver/notmuch-search-toggle-tag "waiting"))))


#+end_src

** Calendar
*** Packages
**** =calfw=

Disabled, for the moment. I've preserved my configuration for future reference.

***** Package
Provided through =app/calendar= in =init.el=.

***** Config
#+begin_src emacs-lisp :tangle config-personal.el
;(use-package! calfw-cal
;  :config
;  (setq
;   ; Start the week on Monday
;   calendar-week-start-day 1))
;
;(use-package! calfw-ical)
;(use-package! calfw-org)
;
;(defun cashweaver/calfw-open ()
;  "Open my calendar"
;  (interactive)
;  (cfw:open-calendar-buffer
;   :contents-sources
;   (list
;    (cfw:org-create-source "Green"))))
#+end_src

* Languages
** General
*** Completion

#+begin_src emacs-lisp :tangle config-personal.el
(setq
 completion-ignore-case t)
#+end_src

*** Packages
**** =aggressive-indent=
***** Package

#+begin_src emacs-lisp :tangle packages-personal.el
(package! aggressive-indent)
#+end_src

**** =langtool=

See https://languagetool.org/

Install =LanguageTool=:

1. Download the [[https://languagetool.org/download/LanguageTool-stable.zip][latest stable build]].
2. Store it somewhere on your system.
3. Configure (see below).

***** Package

Doom emacs provides =langtool= through =init.el=.

***** Config

#+begin_src emacs-lisp :tangle config-personal.el
(use-package! langtool
  :init
  (setq
   langtool-language-tool-server-jar
   "~/third_party/LanguageTool-5.5/languagetool-server.jar"
   ;;langtool-language-tool-jar
   ;;"~/third_party/LanguageTool-5.5/languagetool-commandline.jar"
   )
  :config
  (setq
   langtool-default-language
   "en-US"
   langtool-mother-tongue
   "en"))
#+end_src

**** =operate-on-number=

#+begin_quote
Suppose the point is on some number.  If you want to double it,
invoke `operate-on-number-at-point' followed by some keys: * 2 RET.

/[[github:knu/operate-on-number.el/blob/master/operate-on-number.el][operate-on-number.el]]/
#+end_quote

***** Package

#+begin_src emacs-lisp :tangle packages-personal.el
(package! operate-on-number
  :recipe (:host github
           :repo "knu/operate-on-number.el"))
#+end_src

***** Config

#+begin_src emacs-lisp :tangle config-personal.el
(use-package! operate-on-number)
#+end_src

**** =writeroom-mode=

***** Package

=init.el= provides =writeroom-mode=.

***** Config

#+begin_src emacs-lisp :tangle config-personal.el
(use-package! writeroom-mode
  :config
  (setq
   +zen-mixed-pitch-modes '()
   writeroom-width 30))
#+end_src
** Emacs Lisp (elisp)

Use =aggressive-indent= when editing =elisp=.

#+begin_src emacs-lisp :tangle config-personal.el
(use-package! aggressive-indent
  :config
  (add-hook 'emacs-lisp-mode-hook #'aggressive-indent-mode))
#+end_src

*** Packages
** Java
** TODO Org
*** Packages
**** =anki-editor=
#+begin_quote
anki-editor – An Emacs minor mode for making Anki cards with Org

/[[github:louietan/anki-editor][louietan/anki-editor]]/
#+end_quote

Use my fork of =louitan/anki-editor= to include pull-requests which aren't yet merged.

#+begin_src emacs-lisp :tangle packages-personal.el
(package! anki-editor
  :recipe (:host github
           :repo "cashweaver/anki-editor"))
#+end_src

#+begin_src emacs-lisp :tangle config-personal.el
(use-package! anki-editor)
#+end_src

**** =doct= ([[github:progfolio/doct][Declarative Org Capture Template]])

#+begin_quote
=doct= is a function that provides an alternative, declarative syntax for describing Org capture templates.

/[[github:progfolio/doct][progfolio/doct]]/
#+end_quote

#+begin_src emacs-lisp :tangle packages-personal.el
(package! doct)
#+end_src

#+begin_src emacs-lisp :tangle config-personal.el
(use-package! doct
  :commands (doct))
#+end_src
**** =org-ql=
#+begin_quote
/[[github:alphapapa/org-ql][alphapapa/org-ql]]/

This package provides a query language for Org files. It offers two syntax styles: Lisp-like sexps and search engine-like keywords.
#+end_quote

#+begin_src emacs-lisp :tangle packages-personal.el
(package! org-ql)
#+end_src

#+begin_src emacs-lisp :tangle config-personal.el
(use-package! org-ql)
#+end_src

**** =org-gcal=
#+begin_quote
org-gcal offers

- Fetch google calendar event
- Post/edit org element
- Sync between Org and Gcal

/[[github:kidd/org-gcal.el][kidd/org-gcal.el]]/
#+end_quote

#+begin_src emacs-lisp :tangle packages-personal.el
(package! org-gcal
  :recipe (:host github
           :repo "kidd/org-gcal.el"))
#+end_src

**** =org-mime=

#+begin_quote
This program sends HTML email using Org-mode HTML export.

This approximates a WYSiWYG HTML mail editor from within Emacs, and can be useful for sending tables, fontified source code, and inline images in email.

/[[github:org-mime/org-mime][org-mime/org-mime]]/
#+end_quote

#+begin_src emacs-lisp :tangle packages-personal.el
(package! org-mime)
#+end_src

#+begin_src emacs-lisp :tangle config-personal.el
(use-package! org-mime)
#+end_src

***** TODO Debug "Too early load" error

**** =org-noter=
#+begin_quote
Org-noter’s purpose is to let you create notes that are kept in sync when you scroll through the document, but that are external to it - the notes themselves live in an Org-mode file. As such, this leverages the power of Org-mode (the notes may have outlines, latex fragments, babel, etc…) while acting like notes that are made inside the document. Also, taking notes is very simple: just press i and annotate away!

/[[github:weirdNox/org-noter][weirdNox/org-noter]]/
#+end_quote

I've customized org-noter to [[github:cashweaver/org-noter/commit/e18a4314308d5dd211759682b1aeb083a822673d][wrap quoted text with =begin_quote=/=end_quote=]]

#+begin_src emacs-lisp :tangle packages-personal.el
(package! org-noter
  :recipe (:host github
           :repo "cashweaver/org-noter"))
#+end_src

**** =org-notmuch=

#+begin_quote
[...] implements links to notmuch messages and "searches".  A search is a query to be performed by notmuch; it is the equivalent ;; to folders in other mail clients.  Similarly, mails are referred to ;; by a query, so both a link can refer to several mails.

/ol-notmuch.el/
#+end_quote

#+begin_src emacs-lisp :tangle packages-personal.el
(package! ol-notmuch)
#+end_src
**** =org-super-agenda=

#+begin_quote
This package lets you "supercharge" your Org daily/weekly agenda. The idea is to group items into sections, rather than having them all in one big list.

/[[github:alphapapa/org-super-agenda][alphapapa/org-super-agenda]]/
#+end_quote

#+begin_src emacs-lisp :tangle packages-personal.el
(package! org-super-agenda)
#+end_src
**** =org-roam=
#+begin_quote
Org-roam is a plain-text knowledge management system. It brings some of Roam's more powerful features into the Org-mode ecosystem.

Org-roam borrows principles from the Zettelkasten method, providing a solution for non-hierarchical note-taking. It should also work as a plug-and-play solution for anyone already using Org-mode for their personal wiki.

/[[github:org-roam/org-roam][org-roam/org-roam]]/
#+end_quote

Doom Emacs provides =org-roam=.

#+begin_src emacs-lisp :tangle packages-personal.el
(unpin! org-roam)
#+end_src

**** =ox-pandoc=
#+begin_quote
ox-pandoc is an exporter for Org mode which converts Org-mode files to a wide variety of other formats using the pandoc tool. Pandoc can produce PDFs, HTML, presentations, markdown files, office documents and e-pub publications as well as a number of other more specialised formats.

/[[github:emacsorphanage/ox-pandoc][emacsorphanage/ox-pandoc]]/
#+end_quote


#+begin_src emacs-lisp :tangle packages-personal.el
(package! ox-pandoc)
#+end_src

**** =ox-hugo=
#+begin_quote
ox-hugo is an Org exporter backend that exports Org to Hugo-compatible Markdown (Blackfriday) and also generates the front-matter (in TOML or YAML format).

/[[github:kaushalmodi/ox-hugo]]/
#+end_quote

My corporate profile loads [[github:cashweaver/ox-hugo-corp][cashweaver/ox-hugo-corp]] -- a corporate-safe version of ox-hugo.

#+begin_src emacs-lisp :tangle packages-personal.el
(when (not (cashweaver/is-work-cloudtop-p))
  (package! ox-hugo))
#+end_src

#+begin_src emacs-lisp :tangle config-personal.el
(when (not (cashweaver/is-work-cloudtop-p))
  (use-package! ox-hugo
    :after ox))
#+end_src

**** =org-download=
#+begin_quote
This extension facilitates moving images from point A to point B.

Point A (the source) can be:

1. An image inside your browser that you can drag to Emacs.
1. An image on your file system that you can drag to Emacs.
1. A local or remote image address in kill-ring. Use the org-download-yank command for this. Remember that you can use "0 w" in dired to get an address.
1. A screenshot taken using gnome-screenshot, scrot, gm, xclip (on Linux), screencapture (on OS X) or , imagemagick/convert (on Windows). Use the org-download-screenshot command for this. Customize the backend with org-download-screenshot-method.

Point B (the target) is an Emacs org-mode buffer where the inline link will be inserted. Several customization options will determine where exactly on the file system the file will be stored.

/[[github:abo-abo/org-download]]/
#+end_quote


#+begin_src emacs-lisp :tangle packages-personal.el
(package! org-download)
#+end_src

#+begin_src emacs-lisp :tangle config-personal.el
;; Too early load error
;; (use-package! org-download)
#+end_src
***** TODO Debug "Too early load" error
**** =orgaggregate=

#+begin_quote
Aggregating a table is creating a new table by computing sums, averages, and so on, out of material from the first table.

/[[github:abo-abo/org-download]]/
#+end_quote

#+begin_src emacs-lisp :tangle packages-personal.el
(package! orgtbl-aggregate)
#+end_src

**** =org-transclusion=
#+begin_quote
Org-transclusion lets you insert a copy of text content via a file link or ID link within an Org file. It lets you have the same content present in different buffers at the same time without copy-and-pasting it. Edit the source of the content, and you can refresh the transcluded copies to the up-to-date state. Org-transclusion keeps your files clear of the transcluded copies, leaving only the links to the original content.

[[github:nobiot/org-transclusion]]
#+end_quote


#+begin_src emacs-lisp :tangle packages-personal.el
(package! org-transclusion)
#+end_src

**** =citar=

Doom emacs installs =citar=.

**** Org Citations (=oc=)

Emacs provides =oc= .

**** =ol-doi=

Digital Object Identifier link support.

#+begin_example
[[doi:foo][bar]]
#+end_example

#+begin_src emacs-lisp :tangle packages-personal.el
(package! ol-doi
  :recipe (:repo "https://git.savannah.gnu.org/git/emacs/org-mode.git"
           :branch "main"
           :files ("lisp/ol-doi.el")))
#+end_src

**** =org-protocol=

#+begin_quote
org-protocol intercepts calls from emacsclient to trigger custom actions without external dependencies.

https://orgmode.org/worg/org-contrib/org-protocol.html
#+end_quote

#+begin_src emacs-lisp :tangle packages-personal.el
;;(package! org-protocol)
#+end_src

**** =org-protocol-capture-html=

#+begin_quote
org-protocol is awesome, but browsers do a pretty poor job of turning a page’s HTML content into plain-text. However, Pandoc supports converting from HTML to org-mode, so we can use it to turn HTML into Org-mode content! It can even turn HTML tables into Org tables!

https://github.com/alphapapa/org-protocol-capture-html
#+end_quote

#+begin_src emacs-lisp :tangle packages-personal.el
(package! org-protocol-capture-html
  :recipe (:host github
           :repo "alphapapa/org-protocol-capture-html"))
#+end_src

**** =org-roam-ui=

#+begin_quote
Org-Roam-UI is a frontend for exploring and interacting with your [[https://github.com/org-roam/org-roam][org-roam]] notes.

https://github.com/org-roam/org-roam-ui
#+end_quote

#+begin_src emacs-lisp :tangle packages-personal.el
(package! org-roam-ui)
#+end_src

**** =cashweaver/contacts=

#+begin_src emacs-lisp :tangle config-personal.el
(cl-defun cashweaver/contacts--has-prop? (prop)
  "Returns nil if the contact lacks the PROP."
  (member
   prop
   (org-buffer-property-keys)))

(cl-defun cashweaver/contacts--get-prop (prop)
  "Returns value of PROP or nil if PROP not found."
  (org-entry-get
   (point)
   prop))

(cl-defun cashweaver/contacts--list-top-level-headings ()
  "TODO"
  (org-map-entries
   (lambda ()
     (message (org-entry-get nil "ITEM")))
   "LEVEL=1"))

(cl-defun cashweaver/contacts--heading-exists? (heading-text)
  "Return t if HEADING-TEXT is among top-level headings and nil otherwise."
  (and (org-find-exact-headline-in-buffer
        heading-text)
       t))

(cl-defun cashweaver/contacts--top-level-heading-exists? (heading-text)
  "Return t if HEADING-TEXT is among top-level headings and nil otherwise."
  (member heading-text
          (cashweaver/contacts--list-top-level-headings)))

(cl-defun cashweaver/contacts--list-child-headings ()
  "TODO"
  (interactive)
  (org-map-entries
   (lambda ()
     (org-entry-get nil "ITEM"))
   nil 'tree))

(cl-defun cashweaver/contacts--create-top-level-heading-if-absent (heading-text &optional pos)
  "Creates a top-level heading with HEADING-TEXT at POS if such a heading doesn't exist in buffer.

Returns nil if the heading already existed."
  (let ((pos
         (or pos
             (point-max))))
    (if (member heading-text
                (cashweaver/contacts--list-top-level-headings))
        (return-from
            cashweaver/contacts--create-top-level-heading-if-absent
          nil))

    (goto-char
     pos)
    (org-insert-heading
     ;; arg
     nil
     ;; invisible-ok
     t
     ;; top
     t)
    (insert heading-text)))

(cl-defun cashweaver/contacts--goto-heading (heading-text)
  "Move pointer to the heading with HEADING-TEXT.

Does nothing if such a heading is absent."
  (let ((heading-position
         (org-find-exact-headline-in-buffer
          heading-text)))
    (unless heading-position
      (return-from
          cashwever/contacts--goto-heading
        nil))

    (goto-char
     heading-position)))

(cl-defun cashweaver/contacts-create-reminder (reminder date)
  "Creates a reminder."
  (interactive)
  (cashweaver/contacts--create-top-level-heading-if-absent
   ;; TODO: Convert this to a defcustom.
   "Reminders")
  (cashweaver/contacts--goto-heading
   ;; TODO: Convert this to a defcustom.
   "Reminders")
  (org-insert-subheading
   ;; arg
   nil)
  (insert
   reminder)
  (message date)
  (org-schedule
   ;; arg
   nil
   ;; time
   date)
  (org-set-property
   ;; TODO: Convert this to a defcustom.
   "CREATED_AT"
   (cashweaver/format-time
    "[%Y-%m-%d %a %H:%M:%S]")))

(cl-defun cashweaver/contacts-file? (&optional file)
  "Contacts files are roam files."
  (org-roam-file-p))

(cl-defun cashweaver/contacts--create-birthday-reminder ()
  "Creates an annual birthday reminder."
  (message "foo")
  (unless (cashweaver/contacts-file?)
    (return-from
        cashweaver/contacts--create-birthday-reminder
      nil))

  (unless (cashweaver/contacts--has-prop?
           ;; TODO: Convert this to a defcustom.
           "BIRTHDAY")
    (message "Birthday not set. Cannot create reminder.")
    (return-from
        cashweaver/contacts--create-birthday-reminder
      nil))

  (let ((reminder-text
         (s-format
          "${name}'s Birthday"
          'aget
          `(("name" . ,(cashweaver/contacts--get-name))))))
    (when (cashweaver/contacts--heading-exists?
           reminder-text)
      (message "Birthday reminder exists. Skipping.")
      (return-from
          cashweaver/contacts--create-birthday-reminder
        nil))

    (let* ((birth-date
            (org-read-date
             ;; with-time
             nil
             ;; to-time
             t
             ;; from-string
             (cashweaver/contacts--get-prop
              ;; TODO: Convert this to a defcustom.
              "BIRTHDAY")
             ;; prompt
             nil))
           (birth-month
            (format-time-string
             "%m"
             birth-date))
           (birth-day
            (format-time-string
             "%d"
             birth-date))
           (current-year
            (format-time-string
             "%Y"
             (current-time)))
           (next-year
            (format-time-string
             "%Y"
             (time-add
              (current-time)
              (days-to-time 365))))
           (birthday-has-passed-this-year
            (string<
             (format "%s%s%s" current-year birth-month birth-day)
             (cashweaver/format-time
              "%Y%m%d")))
           (reminder-year
            (if birthday-has-passed-this-year
                next-year
              current-year))
           (reminder-scheduled-date
            (s-format
             "<${year}-${month}-${day} +1y>"
             'aget
             `(("year" . ,reminder-year)
               ("month" . ,birth-month)
               ("day" . ,birth-day)))
            ))
      (cashweaver/contacts-create-reminder
       reminder-text
       reminder-scheduled-date))))

(cl-defun cashweaver/contacts--get-name (&optional path)
  (let ((path
         (or
          path
          (buffer-file-name
           (buffer-base-buffer)))))
    (unless path
      (return-from
          cashweaver/contacts--get-name
        nil))

    (with-current-buffer
        (get-file-buffer path)
      (pcase
          (org-collect-keywords '("TITLE"))
        (`(("TITLE" . ,val))
         (car val))))))

(defcustom cashweaver/contacts-field-birthday
  "BIRTHDAY"
  "Birthday field used in contact properties.")

(defun cashweaver/contacts-aniversaries (contact-file-directory &optional field)
  "Compute FIELD anniversaries for each contact.

Based on `org-contacts-anniversaries'."
  (let ((field
         (or field
             cashweaver/contacts-field-birthday))
        (contact-files
         (org-roam--list-files
          (expand-file-name
           contact-file-directory))))
    ;; (loop for file in contact-files
    ;;       for anniversary = (let ((anniversary
    ;;                                ))))
    ))

(defun cashweaver/contacts--get-contacts ()
  (let ((org-roam-directory
         "~/proj/people")
        (org-roam-db-location
         "~/proj/people/org-roam.db"))
    (when (emacsql-live-p
           (org-roam-db--get-connection))
      (emacsql-close
       (org-roam-db--get-connection)))
    (org-roam-db)
    (org-roam-db-query
     [:select *
      :from nodes])))


;; (cashweaver/contacts--create-birthday-reminder)
;; (cashweaver/contacts--create-top-level-heading-if-absent "foo")
;; (cashweaver/contacts--get-name)
;; (cashweaver/contacts--list-top-level-headings)
#+end_src

***** TODO Move this to separate package file.

**** =org-gtasks=

#+begin_quote
Export/import all Google Tasks to org files.

https://github.com/JulienMasson/org-gtasks
#+end_quote

#+begin_src emacs-lisp :tangle packages-personal.el
(package! org-gtasks
  :recipe (:host github
           :repo "JulienMasson/org-gtasks"))
#+end_src

**** =org-vcard=

#+begin_quote
=org-vcard= is a package for exporting and importing [[https://en.wikipedia.org/wiki/Vcard][vCards]] from within [[https://www.gnu.org/software/emacs/][GNU Emacs]]' [[http://orgmode.org/][Org mode]].

https://github.com/flexibeast/org-vcard#table-of-contents
#+end_quote

#+begin_src emacs-lisp :tangle packages-personal.el
(package! org-vcard)
#+end_src
*** Helper Methods
**** Insert a heading for today

#+begin_src emacs-lisp :tangle config-personal.el
(defun cashweaver/org-mode--heading-text-for-today (&optinoal time-in-heading include-all-tags)
  "Return the heading text for today as a string."
  (let* ((time-in-heading
          (or time-in-heading
              nil))
         (include-all-tags
          (or include-all-tags
              nil))
         (today-week-number
          (cashweaver/format-time
           "%W"))
         (today-quarter-number
          (cashweaver/format-time
           "%q"))
         (today-year
          (cashweaver/format-time
           "%Y"))
         (today-month-number
          (cashweaver/format-time
           "%m"))
         (today-day-number
          (cashweaver/format-time
           "%d"))
         (today-weekday-abbreviated-name
          (cashweaver/format-time
           "%a"))
         (tags
          (if include-all-tags
              (s-format
               ":${year}:${year}week${week-number}:${year}Q${quarter-number}:"
               'aget
               `(("year" . ,today-year)
                 ("week-number" . ,today-week-number)
                 ("quarter-number" . ,today-quarter-number)))
            "")))
    (s-format
     "[${yyyy-mm-dd} ${short-weekday}${hour-minute}] ${tags}"
     'aget
     `(("yyyy-mm-dd" . ,(format "%s-%s-%s"
                                today-year
                                today-month-number
                                today-day-number))
       ("short-weekday" . ,today-weekday-abbreviated-name)
       ("year" . ,today-year)
       ("week-number" . ,today-week-number)
       ("quarter-number" . ,today-quarter-number)
       ("hour-minute" . ,(if time-in-heading
                             (format " %s"
                                     (cashweaver/format-time "%H:%M"))
                           ""))
       ("tags" . ,tags)))))

(defun cashweaver/org-mode-insert-heading-for-today (&optional top time-in-heading include-all-tags)
  "Insert a heading for today's date, with relevant tags."
  (interactive)
  (let ((heading-text
         (cashweaver/org-mode--heading-text-for-today
          ;; top
          nil
          time-in-heading
          include-all-tags))
        (today-yyyy-mm-dd (cashweaver/format-time "%Y-%m-%d"))
        (today-hh-mm (cashweaver/format-time "%H:%M"))
        (today-weekday-abbreviated-name (cashweaver/format-time "%a")))
    (if top
        (org-insert-heading nil t t)
      (org-insert-heading-respect-content))
    (insert
     heading-text)
    (org-set-property
     "Created"
     (format "[%s %s %s]"
             today-yyyy-mm-dd
             today-weekday-abbreviated-name
             today-hh-mm))))

(defun cashweaver/org-mode-heading-marker-for-today ()
  "Return t if a heading for today exists.

Refer to `cashweaver/org-mode-insert-heading-for-today'."
  (let ((headline-text
         (cashweaver/org-mode--heading-text-for-today))
        (headline-marker
         (org-find-exact-headline-in-buffer
          headline-text)))
    headline-marker))
#+end_src

**** Insert a heading for this week

#+begin_src emacs-lisp
(defun cashweaver/org-mode-insert-heading-for-this-week (&optional include-all-tags)
  "Insert a heading for this week, with relevant tags."
  (interactive)
  (let* ((include-all-tags
          (or include-all-tags
              nil))
         (today-week-number
          (cashweaver/format-time "%W"))
         (today-quarter-number
          (cashweaver/format-time "%q"))
         (today-year
          (cashweaver/format-time "%Y"))
         (tags
          (if include-all-tags
              (s-format
               ":${year}week${week-number}:${year}Q${quarter-number}:"
               'aget
               `(("week-number" . ,today-week-number)
                 ("quarter-number" . ,today-quarter-number)))
            (s-format
             ":${year}week${week-number}:"
             'aget
             `(("year" . ,today-year)
               ("week-number" . ,today-week-number))))))
    (org-insert-heading-respect-content)
    (insert
     (s-format
      "${year} Week ${week-number} ${tags}"
      'aget
      `(("year" . ,today-year)
        ("week-number" . ,today-week-number)
        ("tags" . ,tags))))))
#+end_src

**** Insert a log heading for today

#+begin_src emacs-lisp :tangle config-personal.el
(defun cashweaver/org-mode-insert-heading-for-today-log ()
  "Insert a heading for today's date formatted for the log file."
  (interactive)
  (let* ((today-year
          (cashweaver/format-time
           "%Y"))
         (today-month-number
          (cashweaver/format-time
           "%m"))
         (today-day-number
          (cashweaver/format-time
           "%d"))
         (today-YYYY-MM-DD
          (s-lex-format
           "${today-year}-${today-month-number}-${today-day-number}")
          ))
    (cashweaver/org-mode-insert-heading-for-today)
    (org-insert-subheading
     nil)
    (insert
     (s-lex-format
      "[${today-YYYY-MM-DD} 08:00-09:00]"))
    (cl-loop for (start . end) in '(("09:00" . "10:00")
                                    ("10:00" . "11:00")
                                    ("11:00" . "12:00")
                                    ("14:00" . "15:00")
                                    ("15:00" . "16:00")
                                    ("16:00" . "17:00"))
             do
             (org-insert-heading
              nil)
             (insert
              (s-lex-format
               "[${today-YYYY-MM-DD} ${start}-${end}]")))))
#+end_src

**** Scheduling task for my calendar blocks

#+begin_src emacs-lisp :tangle config-personal.el
(setq
 cashweaver/-schedule-block-day '(:start "07:00" :end "19:00")
 cashweaver/-schedule-block-one '(:start "07:00" :end "09:00")
 cashweaver/-schedule-block-two '(:start "09:00" :end "11:00")
 cashweaver/-schedule-block-three '(:start "14:00" :end "16:00")
 cashweaver/-schedule-block-four '(:start "16:00" :end "18:00"))

(defun cashweaver/org-schedule-for-block (block-time &optional date)
  (interactive)
  (let ((start-time (plist-get block-time :start))
        (end-time (plist-get block-time :end))
        (date (or date "today")))
    (org-schedule nil (format "%s %s-%s"
                              date
                              start-time
                              end-time))))

(defun cashweaver/org-schedule-today-from-to (start-time end-time &optional date)
  (interactive)
  (let ((date (or date "today")))
    (org-schedule nil (format "%s %s-%s"
                              date
                              start-time
                              end-time))))
#+end_src

**** Scheduling tanglesk for my calendar blocks

#+begin_src emacs-lisp :tangle config-personal.el
(setq
 cashweaver/-schedule-block-day '(:start "07:00" :end "19:00")
 cashweaver/-schedule-block-one '(:start "07:00" :end "09:00")
 cashweaver/-schedule-block-two '(:start "09:00" :end "11:00")
 cashweaver/-schedule-block-three '(:start "14:00" :end "16:00")
 cashweaver/-schedule-block-four '(:start "16:00" :end "18:00"))

(defun cashweaver/org-schedule-for-block (block-time &optional date)
  (interactive)
  (let ((start-time (plist-get block-time :start))
        (end-time (plist-get block-time :end))
        (date (or date "today")))
    (org-schedule nil (format "%s %s-%s"
                              date
                              start-time
                              end-time))))

(defun cashweaver/org-schedule-today-from-to (start-time end-time &optional date)
  (interactive)
  (let ((date (or date "today")))
    (org-schedule nil (format "%s %s-%s"
                              date
                              start-time
                              end-time))))
#+end_src

**** Schedule task

#+begin_src emacs-lisp :tangle config-personal.el
(defun cashweaver/org--schedule-today-at (start-time-as-string)
  "Schedule a task today at the specified time."
  (interactive "sWhen?: ")
  (message start-time-as-string)
  (string-match
   "^\\([1-9]\\|[01][0-9]\\|2[0-3]\\):?\\([0-5][0-9]\\)?$"
   start-time-as-string)
  (let
      ((hour
        (string-to-number
         (or
          (match-string 1 start-time-as-string)
          "0")))
       (minute
        (string-to-number
         (or
          (match-string 2 start-time-as-string)
          "0"))))
    (org-schedule nil (format "today %02d:%02d"
                              hour
                              minute))
    (message (number-to-string hour))
    ))
#+end_src

**** Schedule task for duration

#+begin_src emacs-lisp :tangle config-personal.el
(defun cashweaver/org--schedule-for (start-time end-time &optional date)
  (let ((date (or date "today")))
    (org-schedule nil (format "%s %s-%s"
                              date
                              start-time
                              end-time))))
    ;(org-schedule nil (format "%s %s-%s"
                              ;date
                              ;start-time
                              ;end-time))))
#+end_src

#+begin_src emacs-lisp :tangle config-personal.el
(defun cashweaver/org--schedule-at-for-minutes (start-minute start-hour duration-in-minutes &optional date)
  (let* ((start-time-in-minutes-since-midnight
         (+ start-minute (* start-hour 60)))
        (end-time-in-minutes-since-midnight
         (+ start-time-in-minutes-since-midnight duration-in-minutes))
        (end-minute (mod end-time-in-minutes-since-midnight 60))
        (end-hour (/ end-time-in-minutes-since-midnight 60))
        (date (or date "today")))
    (org-schedule nil (format "%s %02d:%02d-%02d:%02d"
                              date
                              start-hour
                              start-minute
                              end-hour
                              end-minute))))
#+end_src

**** Scheduling task at start of pomodoro

#+begin_src emacs-lisp :tangle config-personal.el
(setq
 cashweaver/-schedule-pomodoro-one '(:start "09:00" :end "09:50")
 cashweaver/-schedule-pomodoro-two '(:start "10:00" :end "10:50")
 cashweaver/-schedule-pomodoro-three '(:start "11:00" :end "11:50")
 cashweaver/-schedule-pomodoro-four '(:start "12:00" :end "12:50")
 cashweaver/-schedule-pomodoro-five '(:start "13:00" :end "13:50")
 cashweaver/-schedule-pomodoro-six '(:start "14:00" :end "14:50")
 cashweaver/-schedule-pomodoro-seven '(:start "15:00" :end "15:50")
 cashweaver/-schedule-pomodoro-eight '(:start "16:00" :end "16:50")
 cashweaver/-schedule-pomodoro-nine '(:start "17:00" :end "17:50")
 cashweaver/-schedule-pomodoro-ten '(:start "18:00" :end "18:50"))
#+end_src

#+begin_src emacs-lisp :tangle config-personal.el
(defun cashweaver/org-schedule-at-pomodoro (pomodoro-time &optional date)
  (interactive)
  (let ((start-time (plist-get pomodoro-time :start)))
        (date (or date "today")))
    (org-schedule nil (format "%s %s"
                              date
                              start-time)))
#+end_src

**** Scheduling task in N hours

#+begin_src emacs-lisp :tangle config-personal.el
(defun cashweaver/org-schedule-in-n-hours (offset-hours &optional date)
  (interactive)
  (let* ((time-list (parse-time-string (current-time-string)))
         (current-hour (nth 2 time-list))
         (current-minute (nth 1 time-list))
         (hour (mod (+ current-hour offset-hours) 24))
         (date (or date "today")))
    (org-schedule nil (format "%s %s:%s"
                              date
                              hour
                              current-minute))))
#+end_src

**** Scheduling task in N days

#+begin_src emacs-lisp :tangle config-personal.el
(defun cashweaver/org-schedule-in-n-workdays (num-days &optional time)
  (interactive)
  (let*
      ((time (or time "09:00"))
       (offset-days))
    (org-schedule
     nil
     (format "%s %s"
             offset-days
             time))))
#+end_src

**** Goto most recent timestamp in buffer

#+begin_src emacs-lisp :tangle config-personal.el
(defun cashweaver/org-get-timestamps-in-time-order ()
  "Return a list of timestamps from the current buffer in time order."
  (cl-sort
   (org-element-map
       (org-element-parse-buffer)
       'timestamp
     (lambda (timestamp)
       `(,(org-element-property :raw-value timestamp) . ,(org-element-property :begin timestamp))))
   'org-time>
   :key 'car))

(defun cashweaver/org-goto-most-recent-timestamp ()
  "`goto-char' the most recent timestamp in the current buffer."
  (interactive)
  (let ((timestamps
         (cashweaver/org-get-timestamps-in-time-order)))
    (goto-char
     (cdr
      (pop timestamps)))))

(defun cashweaver/org-goto-most-recent-timestamp-with-property (property)
  "`goto-char' the most recent timestamp in the current buffer with a non-nil value for the provided property."
  (interactive)
  (let ((timestamps
         (cashweaver/org-get-timestamps-in-time-order)))
    (goto-char
     (cdr
      (pop timestamps)))
    (while (and timestamps
                (not
                 (org-entry-get
                  (point)
                  property)))
      (goto-char
       (cdr
        (pop timestamps))))))
#+end_src

**** Edit FILETAGS

#+begin_src emacs-lisp :tangle config-personal.el
(defun cashweaver/org-mode-set-filetag (value)
   "Add another option; requires at least one option to already be present."
  (message "---")
  (goto-char
   (point-min))
  (if (search-forward-regexp
       "#\\+\\(FILETAGS\\|filetags\\): "
       ;; bound
       nil
       ;; noerror
       t)
      (progn
        (end-of-line)
        (insert (format "%s:" value)))
    (progn
      ;; Add filetags beneath the title; assumes there is a title
      (goto-char
       (point-min))
      (when (search-forward-regexp
          "^#\\+\\(TITLE\\|title\\):")
        (end-of-line)
        (newline)
        (cashweaver/org-mode-insert-option
         "FILETAGS"
         (format ":%s:"
                 value))))))

(defun cashweaver/org-mode-insert-option (option value)
  "Insert an org-mode option (#+OPTION: VALUE)."
  (insert
   (format
    "#+%s: %s\n"
    option
    value)))
#+end_src

**** Removing RESULT blocks

#+begin_src emacs-lisp :tangle config-personal.el
(defun cashweaver/org-remove-all-results-blocks ()
  "Removes all result blocks; basically an alias"
  (interactive)
  (org-babel-remove-result-one-or-many t))
#+end_src
**** Test for presence of tag

#+begin_src emacs-lisp :tangle config-personal.el
(defun cashweaver/org-mode--has-tag-p (tag)
  "Return t if TAG is a member of the tags of the entry at point."
  (member
   tag
   (org-get-tags)))
#+end_src

*** Lint

Use [[github:/amperser/proselint][Proselint]].

#+begin_src emacs-lisp
(after! org
  :config
  (flycheck-reset-enabled-checker 'proselint))
#+end_src

*** Appearance
#+begin_src emacs-lisp :tangle config-personal.el
(after! org
  (setq
   org-ellipsis " ▾"
   org-hide-leading-stars t))
#+end_src

*** TODO Behavior

TODO Explain

#+begin_src emacs-lisp :tangle config-personal.el
(after! org
  (setq org-refile-targets '((nil :maxlevel . 9)
                             (org-agenda-files :maxlevel . 9))
        org-startup-folded t
        org-log-repeat nil))
#+end_src

**** TODOs
***** Priorities

I use a numeric scale for priorities rather than the default =A= through =C=.

#+begin_src emacs-lisp :tangle config-personal.el
(after! org
  :config
  (setq
   org-priority-highest 0
   org-priority-default 2
   org-priority-lowest 4))
#+end_src

***** Keywords

#+begin_src emacs-lisp :tangle config-personal.el
(after! org
  :config
  (setq
   org-todo-keywords
   '((sequence
      ;; A task that needs doing & is ready to do
      "TODO(t)"
      ;; A project, which usually contains other tasks
      "PROJ(p)"
      ;; A task that is in progress
      "INPROGRESS(i)"
      ;; Something external is holding up this task
      "BLOCKED(b)"
      ;; This task is paused/on hold because of me
      "HOLD(h)"
      "|"
      ;; Task successfully completed
      "DONE(d)"
      ;; Task was moved
      "MOVE(m)"
      ;; Task was cancelled, aborted or is no longer applicable
      "KILL(k)")
     (sequence
      ;; A task that needs doing
      "[ ](T)"
      ;; Task is in progress
      "[-](S)"
      ;; Task is being held up or paused
      "[?](W)"
      "|"
      ;; Task was completed
      "[X](D)"))
   org-todo-keyword-faces
   '(("[-]"  . +org-todo-active)
     ("INPROGRESS" . +org-todo-active)
     ("[?]"  . +org-todo-onhold)
     ("BLOCKED" . +org-todo-onhold)
     ("HOLD" . +org-todo-onhold)
     ("PROJ" . +org-todo-project))))
#+end_src

***** When marking a heading as ...

Save the buffer whenever I make change the state of a todo item. Note: The buffer [[https://emacs.stackexchange.com/questions/55899/how-to-save-a-org-buffer-everytime-the-todo-state-changes#comment87667_55900][will appear modified even after running this snippet]].

#+begin_src emacs-lisp :tangle config-personal.el
;; (after! org
;;   (add-hook!
;;    'org-after-todo-state-change-hook
;;    'save-buffer))
#+end_src

****** =INPROGRESS=

#+begin_src emacs-lisp :tangle config-personal.el
(defun cashweaver/org-mode-when-inprogress ()
  "Handle inprogress behavior."
  ;; Intentionally disabled for the moment. Leave the method here for reference.
  ;; (cond ((string-equal
  ;;         (org-get-todo-state)
  ;;         "INPROGRESS")
  ;;        (org-clock-in)
  ;;        ))
  )

(after! org
  :config
  (add-hook!
   'org-after-todo-state-change-hook
   'cashweaver/org-mode-when-inprogress))
#+end_src

****** Done

Record the current time when marking a heading as done.

#+begin_src emacs-lisp :tangle config-personal.el
(after! org
  :config
  (setq
   org-log-done 'time))
#+end_src

There are three types of actions which can occur when I mark a TODO item as done. They have a precedence and I've listed them in that order.

1. =noop=: The item remains in the same file; nothing happens other than the todo state changing.
2. =cut=: Delete the item.
2. =archive= (default action): Delete and archive the item.

The return value of hooks determine the action we take. All =noop= hooks must return nil before we consider cutting the entry. Likewise, all =cut= hooks must return nil before we archive the entry.

#+begin_src emacs-lisp :tangle config-personal.el
(defcustom cashweaver/org-mode-done-noop-hook
  nil
  "Functions which are non-nil when we should noop the TODO at point."
  :type 'hook)

(defcustom cashweaver/org-mode-done-cut-hook
  nil
  "Functions which are non-nil when we should cut the TODO at point."
  :type 'hook)
#+end_src

#+RESULTS:

******* Tag

******** =noop=

#+begin_src emacs-lisp :tangle config-personal.el
(defcustom cashweaver/org-mode-noop-tag
  "noop"
  "Tag which, when present, indicates that the TODO item should be noop.")

(defun cashweaver/org-mode--has-noop-tag-p ()
  (cashweaver/org-mode--has-tag-p
   cashweaver/org-mode-noop-tag))

(add-hook
 'cashweaver/org-mode-done-noop-hook
 'cashweaver/org-mode--has-noop-tag-p)
#+end_src

#+RESULTS:
| cashweaver/org-mode--has-noop-tag-p |

******** =cut=

#+begin_src emacs-lisp :tangle config-personal.el
(defcustom cashweaver/org-mode-cut-tag
  "cut"
  "Tag which, when present, indicates that the TODO item should be cut.")

(defun cashweaver/org-mode--has-cut-tag-p ()
  (cashweaver/org-mode--has-tag-p
   cashweaver/org-mode-cut-tag))

(add-hook
 'cashweaver/org-mode-done-cut-hook
 'cashweaver/org-mode--has-cut-tag-p)
#+end_src

******* File

******** =noop=
#+begin_src emacs-lisp :tangle config-personal.el
(defcustom cashweaver/org-mode--done-noop-file-paths
  nil
  "TODOs in these files will be noop by default.")

(defun cashweaver/org-mode--done-in-noop-file-p ()
  (member
   buffer-file-name
   cashweaver/org-mode--done-noop-file-paths))

(add-hook
 'cashweaver/org-mode-done-noop-hook
 'cashweaver/org-mode--done-in-noop-file-p)
#+end_src

******** =cut=
#+begin_src emacs-lisp :tangle config-personal.el
(defcustom cashweaver/org-mode--done-cut-file-paths
  nil
  "TODOs in these files will be cut by default.")

(defun cashweaver/org-mode--done-in-cut-file-p ()
  (member
   buffer-file-name
   cashweaver/org-mode--done-cut-file-paths))

(add-hook
 'cashweaver/org-mode-done-cut-hook
 'cashweaver/org-mode--done-in-cut-file-p)
#+end_src

******* State
******** Repeating

#+begin_src emacs-lisp :tangle config-personal.el
(add-hook
 'cashweaver/org-mode-done-noop-hook
 (lambda ()
   (org-get-repeat)))
#+end_src
******** =KILL=

#+begin_src emacs-lisp :tangle config-personal.el
(add-hook
 'cashweaver/org-mode-done-cut-hook
 (lambda ()
   (string=
    org-state
    "KILL")))
#+end_src

******* Install hooks

#+begin_src emacs-lisp :tangle config-personal.el
(defun cashweaver/org-mode--should-noop-todo-when-done-p ()
  "Return non-nil if we should noop the current entry."
  (-any
   'funcall
   cashweaver/org-mode-done-noop-hook))

(defun cashweaver/org-mode--should-cut-todo-when-done-p ()
  "Return non-nil if we should cut the current entry."
  (-any
   'funcall
   cashweaver/org-mode-done-cut-hook))

(defun cashweaver/org-mode-when-done ()
  "Archive entry when it is marked as done (as defined by `org-done-keywords')."
  (when (org-entry-is-done-p)
    (org-clock-out-if-current)
    (cond
     ((cashweaver/org-mode--should-noop-todo-when-done-p)
      nil)
     ((cashweaver/org-mode--should-cut-todo-when-done-p)
      (org-cut-subtree))
     (t
      (org-archive-subtree-default)))))

(after! org
  :config
  (add-hook!
   'org-after-todo-state-change-hook
   'cashweaver/org-mode-when-done))
#+end_src

**** Blocks

#+begin_src emacs-lisp :tangle config-personal.el
(after! org
  :config
  (setq
   org-structure-template-alist
   '(("a" . "export ascii")
     ("c" . "center")
     ("C" . "comment")
     ("e" . "example")
     ("E" . "export")
     ("Eh" . "export html")
     ("El" . "export latex")
     ("q" . "quote")
     ("s" . "src")
     ("se" . "src emacs-lisp")
     ("v" . "verse"))))
#+end_src

*** Capture Templates

#+begin_src emacs-lisp :tangle config-personal.el
(after! org
  (setq
   org-capture-templates (doct '(("Anki"
                                  :keys "a"
                                  :file "~/proj/anki-cards/anki.org"
                                  :olp ("Default")
                                  :note-type (lambda ()
                                               (completing-read
                                                "Note type: "
                                                (sort
                                                 (anki-editor-note-types)
                                                 #'string-lessp)))
                                  :note-type-prop anki-editor-prop-note-type
                                  :template ("* %?"
                                             ":PROPERTIES:"
                                             ":ANKI_NOTE_TYPE: %{note-type}"
                                             ":END:")
                                  :hook (lambda ()
                                          (let* ((note-type
                                                  (org-entry-get
                                                   (point)
                                                   anki-editor-prop-note-type))
                                                 (fields
                                                  (anki-editor-api-call-result
                                                   'modelFieldNames
                                                   :modelName note-type))
                                                 ;; Ignore the first field.
                                                 ;; We'll set it as the title for the subtree.
                                                 (first-field
                                                  (pop fields))
                                                 (second-field
                                                  (pop fields)))
                                            (org-insert-subheading nil)
                                            (insert second-field)
                                            (dolist (field fields)
                                              (org-insert-heading nil)
                                              (insert field))
                                            (outline-up-heading 1)
                                            (evil-org-append-line 1))))))))
#+end_src

*** Links
**** Base

#+begin_src emacs-lisp :tangle packages-personal.el
(package! org-link-base
  :recipe (:host github
           :repo "cashweaver/org-link-base"))
#+end_src

#+begin_src emacs-lisp :tangle config-personal.el
(use-package! org-link-base)
#+end_src

**** Digital Object Identifier (DOI)

#+begin_src emacs-lisp :tangle config-personal.el
(use-package! ol-doi)
#+end_src

**** ISBN

#+begin_src emacs-lisp :tangle packages-personal.el
(package! org-link-isbn
  :recipe (:host github
           :repo "cashweaver/org-link-isbn"))
#+end_src

#+begin_src emacs-lisp :tangle config-personal.el
(use-package! org-link-isbn)
#+end_src

**** Instagram

#+begin_src emacs-lisp :tangle packages-personal.el
(package! org-link-instagram
  :recipe (:host github
           :repo "cashweaver/org-link-instagram"))
#+end_src

#+begin_src emacs-lisp :tangle config-personal.el
(use-package! org-link-instagram)
#+end_src

**** Google Documents

#+begin_src emacs-lisp :tangle packages-personal.el
(package! org-link-google-doc
  :recipe (:host github
           :repo "cashweaver/org-link-google-doc"))
#+end_src

#+begin_src emacs-lisp :tangle config-personal.el
(use-package! org-link-google-doc)
#+end_src

**** Google Sheets

#+begin_src emacs-lisp :tangle packages-personal.el
(package! org-link-google-sheet
  :recipe (:host github
           :repo "cashweaver/org-link-google-sheet"))
#+end_src

#+begin_src emacs-lisp :tangle config-personal.el
(use-package! org-link-google-sheet)
#+end_src

*** TODO Agendas

#+begin_src emacs-lisp :tangle config-personal.el
(use-package! org-agenda)
(use-package! evil-org-agenda)
(use-package! org-super-agenda
  :demand t
  :after
  (:all
   org-agenda
   evil
   evil-org-agenda)
  :hook
  ((org-agenda-mode . org-super-agenda-mode))
  :config
  (setq
   ;; TODO: Move this variable
   cashweaver/roam-dir-path (s-format
                             "${home-dir-path}/proj/roam"
                             'aget
                             `(("home-dir-path" . ,cashweaver/home-dir-path)))
   cashweaver/roam-unread-file-path (s-format
                                     "${roam-dir-path}/unread.org"
                                     'aget
                                     `(("roam-dir-path" . ,cashweaver/roam-dir-path)))
   org-super-agenda-header-map evil-org-agenda-mode-map
   org-agenda-custom-commands '(("r"
                                 "Roam"
                                 ((alltodo
                                   ""
                                   ((org-agenda-overriding-header "")
                                    (org-agenda-files
                                     (let ((org-roam-directory
                                            cashweaver/roam-dir-path))
                                       (remove
                                        cashweaver/roam-unread-file-path
                                        (org-roam-list-files))))
                                    (org-super-agenda-groups
                                     `(,(cashweaver/org-super-agenda--group-by-priority)
                                       ;; (:name "Todos"
                                       ;;  :todo t)
                                       ))))))
                                ("R"
                                 "Roam Unread"
                                 ((alltodo
                                   ""
                                   (
                                    (org-agenda-overriding-header "")
                                    (org-agenda-files
                                     `(,cashweaver/roam-unread-file-path))
                                    (org-super-agenda-groups
                                     `(
                                       (:name "essay (10)"
                                        :take (10 (:and
                                                   (:tag "essay"
                                                    :not (:tag "someday"
                                                          :tag "link_group")))))
                                       ,(cashweaver/org-super-agenda--roam-group
                                         "discussion"
                                         10)
                                       ,(cashweaver/org-super-agenda--roam-group
                                         "book"
                                         10)
                                       ,(cashweaver/org-super-agenda--roam-group
                                         "link_group"
                                         10)
                                       ,(cashweaver/org-super-agenda--roam-group
                                         "class"
                                         10)
                                       (:name "someday (10)"
                                        :take (10 (:and (:tag "someday"))))

                                       (:discard
                                        (:todo t)
                                        )))))))))

  (cl-defun org-super-agenda--group-dispatch-take (items (n group))
    ;;(cl-defun org-super-agenda--group-dispatch-take (items n-and-group)
    "Take N ITEMS that match selectors in GROUP.
If N is positive, take the first N items, otherwise take the last N items.
Note: the ordering of entries is not guaranteed to be preserved, so this may
not always show the expected results."
    (message (format "%s" group))
    (-let* (((name non-matching matching) (org-super-agenda--group-dispatch items group))
            (take-fn (if (cl-minusp n) #'-take-last #'-take))
            (placement (if (cl-minusp n) "Last" "First"))
            (name (format "%s %d %s" placement (abs n) name)))
      (list name non-matching (funcall take-fn (abs n) matching)))))

(defun cashweaver/org-super-agenda--group-by-priority ()
  "Group by my priorities (e.g. p0 through p4)."
  '(:auto-map
    (lambda (item)
      (-when-let* ((marker (or (get-text-property 0 'org-marker item)
                               (get-text-property 0 'org-hd-marker)))
                   (priority (org-entry-get
                              marker
                              "PRIORITY")))
        (if (string= priority "")
            "unknown"
         (s-lex-format
          "p${priority}")
          )))))

(defun cashweaver/org-super-agenda--roam-group (tag take)
  "Return a plist TODO."
  `(:name ,(format "%s (%d)"
                   tag
                   take)
    :take (,take
           (:and
            (:tag ,tag
             :not (:tag "someday"))))))
#+end_src

#+RESULTS:
: cashweaver/org-super-agenda--roam-group

#+begin_src emacs-lisp :tangle config-personal.el
(after! org
  :config
  (setq
   calendar-week-start-day 1
   org-agenda-entry-text-maxlines 30
   org-agenda-entry-text-leaders "  "
   ))
#+end_src

#+begin_src emacs-lisp :tangle config-personal.el
(defun cashweaver/org-mode-buffer-property-get (property-name)
  (org-with-point-at 1
    (when (re-search-forward
           (concat "^#\\+" property-name ": \\(.*\\)")
           (point-max) t)
      (buffer-substring-no-properties
       (match-beginning 1)
       (match-end 1)))))
#+end_src

#+begin_src emacs-lisp :tangle config-personal.el
(after! org-agenda
  (setq
   org-duration-units `(("m" . 1)
                        ("min" . 1)
                        ("mins" . 1)
                        ("h" . 60)
                        ("d" . ,(* 60 24))
                        ("w" . ,(* 60 24 7))
                        ("mo" . ,(* 60 24 30))
                        ("mos" . ,(* 60 24 30))
                        ("M" . ,(* 60 24 30))
                        ("y" . ,(* 60 24 365.25)))
   org-agenda-skip-scheduled-if-deadline-is-shown t
   org-agenda-skip-scheduled-if-done t
   org-agenda-skip-scheduled-if-done t
   org-agenda-skip-deadline-if-done t
   org-agenda-include-deadlines t
   org-agenda-block-separator nil
   org-agenda-compact-blocks t
   org-agenda-start-day nil ;; i.e. today
   org-agenda-span 1
   org-agenda-start-on-weekday nil))
#+end_src

*** TODO Transclusion

#+begin_src emacs-lisp :tangle config-personal.el
(use-package! org-transclusion
  :after org
  :config
  (setq
   org-transclusion-exclude-elements '(property-drawer
                                       keyword)
   org-transclusion-extensions-loaded t
   org-transclusion-extensions '(org-transclusion-src-lines
                                 org-transclusion-font-lock
                                 org-transclusion-indent-mode))
  (add-hook! 'org-mode-hook 'org-transclusion-mode)
  ;; (set-face-attribute
  ;;  'org-transclusion-fringe nil
  ;;  :foreground "white"
  ;;  :background nil)
  (define-fringe-bitmap 'org-transclusion-fringe-bitmap
    [17 34 68 136 68 34 17]
    nil nil 'center)
  ;; Re-load extensions to activate `org-transclusion-indent-mode'.
  (org-transclusion-load-extensions-maybe t))
#+end_src

*** Tables

#+begin_src emacs-lisp :tangle config-personal.el
(use-package! orgtbl-aggregate)
#+end_src

*** Anki

#+begin_src emacs-lisp :tangle config-personal.el
;; Too early load error
(use-package! anki-editor
  :config
  (setq
   anki-editor-remove-single-paragraph-tags t
   anki-editor-latex-style 'mathjax))

(defun cashweaver/anki-editor-insert-note ()
  (interactive)
  (with-current-buffer
      (find-file-noselect
       "~/proj/anki-cards/anki.org")
    (point-min)
    (anki-editor-insert-note)))
#+end_src

**** TODO Debug "Too early load" error

*** TODO Export and Publish
#+begin_src emacs-lisp :tangle config-personal.el
(after! org
  :config
  (setq
   org-export-with-tags nil))
#+end_src
**** TODO Config

#+begin_src emacs-lisp :tangle config-personal.el
(defun org-pandoc-pan-to-pub (o)
  (intern
   (format ":org-pandoc-%s" o)))

(use-package! ox-pandoc
  :after (:all org)
  :config
  (setq
   org-pandoc-format-extensions '(pipe_tables+raw_html)
   org-pandoc-menu-entry
   '((?D "to docx and open." org-pandoc-export-to-docx-and-open)
     (?d "to docx." org-pandoc-export-to-docx)
     (?m "to markdown." org-pandoc-export-to-markdown)
     (?M "to markdown and open." org-pandoc-export-to-markdown-and-open)))
  (defconst org-pandoc-publish-options
    (mapcar
     'org-pandoc-pan-to-pub
     (append
      org-pandoc-valid-options
      org-pandoc-colon-separated-options
      org-pandoc-file-options)))
  (when (cashweaver/is-work-p)
    (setq
     org-pandoc-options-for-docx
     '((lua-filter . "/usr/local/google/home/cashweaver/third_party/google_docs_pandoc/pandoc/GenericDocFilter.lua")
       (reference-doc . "/usr/local/google/home/cashweaver/third_party/google_docs_pandoc/pandoc/CashWeaverGenericDocTemplate.docx")
       ;;(reference-doc . "/usr/local/google/home/cashweaver/third_party/google_docs_pandoc/pandoc/GenericDocTemplate.docx")
       (highlight-style . "/usr/local/google/home/cashweaver/third_party/google_docs_pandoc/pandoc/Kodify.theme")))
    (add-hook! 'org-pandoc-after-processing-markdown-hook
               'cashweaver/remove-yaml-header)
    ))

(defun cashweaver/remove-yaml-header ()
  "Remove the 'front matter'/YAML header content from the current buffer."
  (goto-char (point-min))
  (replace-regexp
   "---\\(.\\|\n\\)*?---"
   "")
  (goto-char (point-min))
  (delete-blank-lines)
  (delete-blank-lines))

(defun cashweaver/remove-toml-header ()
  "Remove the 'front matter'/TOML header content from the current buffer."
  (goto-char (point-min))
  (replace-regexp
   "\\+\\+\\+\\(.\\|\n\\)*?\\+\\+\\+"
   "")
  (goto-char (point-min))
  (delete-blank-lines)
  (delete-blank-lines))

(defun cashweaver/get-toml-header ()
  "Return the 'front matter'/TOML header content from the current buffer."
  (save-excursion
    (goto-char (point-min))
    (search-forward-regexp
     "\\+\\+\\+\n\\(\\(.\\|\n\\)*?\\)\n\\+\\+\\+")
    (match-string 1)))

(defun cashweaver/remove-yaml-front-matter-current-buffer ()
  (interactive)
  (cashweaver/remove-yaml-header))

(defun cashweaver/remove-toml-front-matter-current-buffer ()
  (interactive)
  (cashweaver/remove-toml-header))


(defun cashweaver/get-title-toml-front-matter ()
  (interactive)
  (let* ((toml-string
          (cashweaver/get-toml-header))
         (toml-lines
          (split-string
           toml-string
           "\n"))
         (title
          (replace-regexp-in-string
           "title = \"\\(.*\\)\""
           "\\1"
           (nth 0 (seq-filter
                   (lambda (line)
                     (s-starts-with?
                      "title"
                      line))
                   toml-lines)))))
    title))

(defun cashweaver/replace-toml-front-matter-with-md-heading ()
  (interactive)
  (let ((title
         (cashweaver/get-title-toml-front-matter)))
    (cashweaver/remove-toml-header)
    (save-excursion
      (goto-char
       (point-min))
      (insert
       (format
        "# %s\n\n"
        title)))))

(defun org-pandoc-publish-to (format plist filename pub-dir &optional remove-yaml-header)
  "Publish using Pandoc (https://github.com/kawabata/ox-pandoc/issues/18#issuecomment-262979338)."
  (setq
   org-pandoc-format format
   org-pandoc-option-table (make-hash-table))
  (let ((tempfile
         (org-publish-org-to
          'pandoc filename (concat (make-temp-name ".tmp") ".org") plist pub-dir))
        (outfile (format "%s.%s"
                         (concat
                          pub-dir
                          (file-name-sans-extension (file-name-nondirectory filename)))
                         (assoc-default format org-pandoc-extensions))))
    (org-pandoc-put-options (org-pandoc-plist-to-alist plist))
    (let ((process
           (org-pandoc-run tempfile outfile format 'org-pandoc-sentinel
                           org-pandoc-option-table))
          (local-hook-symbol
           (intern (format "org-pandoc-after-processing-%s-hook" format))))
      (process-put process 'files (list tempfile))
      (process-put process 'output-file outfile)
      (process-put process 'local-hook-symbol local-hook-symbol))))

(defun org-pandoc-pub-to-pan (o)
  (intern
   (substring (symbol-name o) 12)))

(defun org-pandoc-plist-to-alist (plist)
  (let ((alist '()))
    (while plist
      (let ((p (car plist))
            (v (cadr plist)))
        (when (member p org-pandoc-publish-options)
          (add-to-list 'alist (cons (org-pandoc-pub-to-pan p) v))))
      (setq plist (cddr plist)))
    alist))

(defun org-pandoc-publish-to-md (plist filename pub-dir)
  "Publish to markdown using Pandoc."
  ;;(org-pandoc-publish-to 'markdown plist filename pub-dir t))
  (org-pandoc-publish-to 'markdown plist filename pub-dir t))

(defun org-pandoc-publish-to-plain (plist filename pub-dir)
  "Publish to markdown using Pandoc."
  (org-pandoc-publish-to 'plain plist filename pub-dir))
#+end_src

**** TODO Hugo

***** Config

#+begin_src emacs-lisp :tangle config-personal.el
(defun cashweaver/org-hugo-export-all (directory)
  "Export all hugo files in DIRECTORY."
  (interactive)
  (let ((directory
         (or directory
             (concat "%s/proj/roam"
                     cashweaver/home-dir-path)
             (mapc (lambda (filepath)
                     (run-function-in-file
                      filepath
                      'cashweaver/org-hugo-export-wim-to-md))
                   (directory-files
                    directory
                    ;; full
                    t
                    ;; match
                    ".org$")))))))

(defun cashweaver/org-mode--split-tags-to-list (tags-as-string)
  "Strip the wrapping ':' from TAG; if present."
  (if tags-as-string
      (if (string-match
           "^:\\(.*\\):$"
           tags-as-string)
          (split-string
           (match-string 1 tags-as-string)
           ":")
        nil)
    nil))

(defun cashweaver/org-hugo--tag-processing-fn-roam-tags (tag-list info)
  "Add tags from filetags to tag-list for org-roam to ox-hugo compatibility.

Reference: https://sidhartharya.me/exporting-org-roam-notes-to-hugo/#goal

See `org-hugo-tag-processing-functions'."
  (if (org-roam-file-p)
      (let* ((filetags
              (car
               (cdr
                (assoc-string
                 "FILETAGS"
                 (org-collect-keywords
                  '("FILETAGS"))))))
             (filetag-list
              (or
               (cashweaver/org-mode--split-tags-to-list
                filetags)
               '())))
        (append tag-list
                (mapcar
                 #'downcase
                 filetag-list)))
    tag-list))

(after! ox-hugo
  (setq
   org-hugo-allow-spaces-in-tags nil)
  (add-to-list
   'org-hugo-tag-processing-functions
   'cashweaver/org-hugo--tag-processing-fn-roam-tags))
#+end_src

**** Publish

#+begin_src emacs-lisp :tangle config-personal.el
(after! org
  (setq
   org-publish-project-alist
   '(("cashweaver.com"
      :base-directory "~/proj/blog-posts/posts/"
      :base-extension "org"
      :publishing-directory "~/proj/cashweaver.com/content/posts/"
      ;;:publishing-function org-pandoc-publish-to-md
      :publishing-function org-hugo-export-to-md
      :section-numbers t
      :with-toc nil))))

;; Publish org-roam files without using org-publish because org-publish requires a top-level headline.
;; ("roam"
;; :base-directory "~/proj/roam/"
;; :base-extension "org"
;; :publishing-directory "~/proj/cashweaver.com/content/posts/"
;; :publishing-function org-hugo-export-to-md
;; :table-of-contents nil
;; :section-numbers t
;; :with-toc nil))))


#+end_src

**** Helper Functions

#+begin_src emacs-lisp :tangle config-personal.el
(defcustom
  cashweaver/smart-to-ascii
  '(("\x201C" . "\"")
    ("\x201D" . "\"")
    ("\x2018" . "'")
    ("\x2019" . "'"))
  "Mapping from known 'smart' quotes/etc to their ascii equivalent.")

(defun cashweaver/replace-smart-quotes (beg end)
  "Replace 'smart quotes' in buffer or region with ascii quotes.

Reference: https://superuser.com/a/604264"
  (interactive "r")
  (format-replace-strings
   cashweaver/smart-to-ascii
   nil
   beg
   end))

(defun cashweaver/replace-smart-quotes-in-buffer ()
  "Replace 'smart quotes' in current buffer."
  (interactive)
  (cashweaver/replace-smart-quotes
   (point-min)
   (point-max)))
#+end_src

*** Mail

#+begin_src emacs-lisp :tangle config-personal.el
(use-package! ol-notmuch
  :after org)
#+end_src

*** Notes
**** TODO Roam

I use =org-roam= for [[github:cashweaver/roam][general]] and private notes. Each roam directory contains a =.dir-locals.el= file which configures things like capture templates and =before-save-hook=.

#+begin_src emacs-lisp :tangle config-personal.el
(defun cashweaver/org-set-last-modified ()
  (interactive)
  (when (derived-mode-p 'org-mode)
    (save-excursion
      (goto-char
       (point-min))
      (org-set-property
       "LAST_MODIFIED"
       (cashweaver/format-time
        "[%Y-%m-%d %a %H:%M]")))))

;; (after! org
;;   (add-hook!
;;     'before-save-hook
;;     (cashweaver/org-set-last-modified)))
#+end_src

#+begin_src emacs-lisp :tangle config-personal.el
(add-hook
 'cashweaver/org-mode-done-cut-hook
 'org-roam-file-p)
#+end_src

#+RESULTS:
| org-roam-file-p | (lambda nil (string= org-state KILL)) | cashweaver/org-mode--done-in-cut-file-p | cashweaver/org-mode--has-cut-tag-p |

#+begin_src emacs-lisp :tangle config-personal.el
(defvar
  cashweaver/org-roam--file-path-exceptions-to-export-after-save
  '()
  "List of org-roam file paths which should NOT be exported after they are saved. This list is populated within the particular .dir-local.el files.")

(defvar
  cashweaver/org-roam--file-path-exceptions-to-mirror-refs-to-front-matter
  '()
  "List of org-roam file paths which should NOT have references mirrored to front matter. This list is populated within the particular .dir-local.el files.")
#+end_src

#+begin_src emacs-lisp :tangle config-personal.el
(defun cashweaver/org-hugo-export-wim-to-md ()
  "Function for `after-save-hook' to run `org-hugo-export-wim-to-md'.

The exporting happens only when Org Capture is not in progress."
  (interactive)
  (when (and
         (not
          (eq real-this-command 'org-capture-finalize))
         (not
          (member
           (buffer-file-name)
           cashweaver/org-roam--file-path-exceptions-to-export-after-save)))
    (save-excursion
      (let* ((org-id-extra-files
              (org-roam-list-files))
             (export-file-path
              (org-hugo-export-wim-to-md)))
        (when cashweaver/org-hugo-replace-front-matter-with-title
          (with-current-buffer
              (find-file-noselect
               export-file-path)
            (cashweaver/replace-toml-front-matter-with-md-heading)
            (save-buffer)))))))

(after! org-roam
  (defun org-hugo-export-wim-to-md-after-save ()
    (cashweaver/org-hugo-export-wim-to-md)))
#+end_src

#+begin_src emacs-lisp :tangle config-personal.el
(use-package! org-roam
  :after org
  :config
  (setq
   cashweaver/org-hugo-replace-front-matter-with-title nil))

(defun cashweaver/org-roam-rewrite-smart-to-ascii ()
  (when (org-roam-file-p)
    (cashweaver/replace-smart-quotes-in-buffer)))

(defun cashweaver/org-roam--get-filetags (&optional node-id)
  "Return a list of all tags used in roam.

Optionally: Exclude tags currently in use in the provided NODE-ID."
  (if node-id
      (org-roam-db-query
       [:select :distinct [tag]
        :from tags
        :where tag :not-in [:select tag
                            :from tags
                            :where (= node_id $s1)]]
       node-id)
    (org-roam-db-query
     [:select :distinct tag
      :from tags])))

;; TODO
(defun cashweaver/org-roam--get-all-drafts ()
  "Return a list of nodes which are marked as drafts.")

(defun cashweaver/org-roam--set-filetag (&optional node-id)
  "Add a filetag in the current file."
  (let ((tag
         (completing-read
          "Select tag: "
          (cashweaver/org-roam--get-filetags node-id)
          )))
    (cashweaver/org-mode-set-filetag tag)))

;;(org-roam-db-query "SELECT DISTINCT tag FROM tags;")
;; "007bbe54-0e36-4af5-b2ec-cf7762299a1f"

;; (let ((current-file-id "6a214828-bea5-47be-bac7-0f0235b0ff3c"))
;;   (org-roam-db-query
;;    [:select :distinct [tag]
;;     :from tags
;;     :where (= node_id $s1)]
;;    current-file-id))

;; (let ((current-file-id "6a214828-bea5-47be-bac7-0f0235b0ff3c"))
;;   (org-roam-db-query
;;    (format
;;     ;; "SELECT DISTINCT tag
;;     ;; FROM tags
;;     ;; WHERE NOT IN (
;;     ;; SELECT tag
;;     ;; FROM tags
;;     ;; WHERE node_id = '\"%s\"'
;;     ;; )"
;;     "SELECT DISTINCT tag
;; FROM tags
;; WHERE node_id = '\"%s\"'"
;;     current-file-id)))
;; (let ((current-file-id "6a214828-bea5-47be-bac7-0f0235b0ff3c"))
;;   (org-roam-db-query
;;    [:select :distinct [tag]
;;     :from tags
;;     :where tag :not-in [:select tag
;;                         :from tags
;;                         :where (= node_id $s1)]]
;;    current-file-id))


(defun cashweaver/org-roam-make-filepath (title &optional time time-zone)
  "Return a filenaem for an org-roam node.

Reference: https://ag91.github.io/blog/2020/11/12/write-org-roam-notes-via-elisp"
  (let ((slug
         (org-roam-node-slug
          (org-roam-node-create
           :title title))))
    (format
     "%s/%s.org"
     org-roam-directory
     slug)))

(defun cashweaver/org-mode-add-option (option value)
  "Add another option; requires at least one option to already be present.

TODO: move to org-mode section"
  (goto-char
   (point-max))
  (insert "foo")
  (when (search-backward-regexp
         "#\\+[A-Za-z_]+:"
         ;; bound
         nil
         ;; noerror
         t)
    (cashweaver/org-mode-insert-option
     option
     value)))

(defun cashweaver/org-mode-insert-option (option value)
  "Insert an org-mode option (#+OPTION: VALUE).

TODO: move to org-mode section"
  (insert
   (format
    "#+%s: %s\n"
    option
    value)))

(defun cashweaver/org-mode-insert-options (options)
  "Insert an alist of org-mode options (#+OPTION: VALUE)."
  (cl-loop for (option . value) in options
           do (cashweaver/org-mode-insert-option
               option
               value)))

(defun cashweaver/org-mode-insert-property (property value)
  "Insert an org-mode property (:PROPERTY: VALUE)."
  (insert
   (format
    ":%s: %s\n"
    property
    value)))

(defun cashweaver/org-mode-insert-properties (properties)
  "Insert an alist of org-mode properties (:PROPERTY: VALUE).

When WRAP is non-nil: Wrap the properties with :PROPERTIES:/:END:."
  (interactive)
  (cl-loop for (property . value) in properties
           do (org-set-property
               property
               value)))

(defun cashweaver/org-roam-new-node (file-path title &optional properties)
  "Build a new org-roam node in a temp file.

PROPERTIES is expected to be an alist of additional properties to include.

Reference: https://ag91.github.io/blog/2020/11/12/write-org-roam-notes-via-elisp"
  (let* ((id
          (org-id-new))
         (created-date
          (cashweaver/format-time
           "[%Y-%m-%d %a %H:%M]"))
         (all-properties
          (append
           `(("ID" . ,id))
           properties)))
    (with-temp-file
        file-path
      (cashweaver/org-mode-insert-properties
       all-properties)
      (goto-char
       (point-max))
      (cashweaver/org-mode-insert-options
       `(("TITLE" . ,title)
         ("AUTHOR" . "Cash Weaver")
         ("DATE" . ,created-date)
         ("HUGO_AUTO_SET_LASTMOD" . "t")))
      (insert "")
      (org-insert-heading)
      (insert
       "TODO Summary")
      (org-insert-heading)
      (insert
       "TODO Notes")
      (org-insert-heading)
      (insert
       "TODO Thoughts"))))

(defun cashweaver/org-roam-new-node-from-link-heading-at-point (&optional mark-as-done)
  "Build a new org-roam node from the link heading at point."
  (interactive)
  (let* ((link
          (org-element-context))
         (type
          (org-element-property
           :type
           link))
         (url
          (org-element-property
           :raw-link
           link))
         (description
          (cashweaver/org-mode-get-description-from-link-at-point))
         (org-roam-node-file-path
          (cashweaver/org-roam-make-filepath description)))
    ;; TODO Replace with regexp?
    (unless (or (string= type "http")
                (string= type "https")))
    (cashweaver/org-roam-new-node
     org-roam-node-file-path
     description
     `(("ROAM_REFS" . ,url)))
    (if mark-as-done
        (org-todo "DONE"))
    (find-file
     org-roam-node-file-path)))

(defun cashweaver/org-mode-get-description-from-link-at-point ()
  "Reference: https://emacs.stackexchange.com/a/38297"
  (interactive)
  (let ((link
         (org-element-context)))
    (message
     "%s"
     (buffer-substring-no-properties
      (org-element-property
       :contents-begin
       link)
      (org-element-property
       :contents-end
       link)))))


(defun cashweaver/org-roam-open-ref ()
  "Open the ROAM_REF."
  (interactive)
  (let ((roam-refs
         (org-entry-get
          (point)
          "ROAM_REFS")))
    (message roam-refs)
    (if (s-starts-with-p
         "http"
         roam-refs)
        (browse-url roam-refs)
      (message
       "Not an http(s) ref (%s)"
       roam-refs))))


;; This bit is no longer necessary as I've discovered .dir-locals.el.
;; Setting `org-attach-directory' in .dir-locals.el has the desired
;; effect of this function.
;;
;; (defun cashweaver/org-roam-insert-attachment-path ()
;;   (let ((dir
;;          (format
;;           "%s/%s"
;;           cashweaver/org-roam-attachment-base-path
;;           (org-id-get))))
;;     (save-excursion
;;       (org-set-property
;;        "DIR"
;;        dir))))
;; (after! org-roam
;;   (remove-hook! 'org-roam-capture-new-node-hook
;;               'cashweaver/org-roam-insert-attachment-path))

(defun cashewaver-org-roam--append-to-custom-front-matter (key value)
  "Append the provided KEY and VALUE to hugo_custom_front_matter."
  (when (org-roam-file-p)
    (let
        ((keyword
          "HUGO_CUSTOM_FRONT_MATTER")
         (current-value
          (org-collect-keywords
           keyword)))
      (message current-value)
      (org-roam-set-keyword
       (downcase keyword)
       (format "%s %s"
               key
               value)))))

(defun cashweaver/org-roam--mirror-roam-aliases-to-hugo-aliases ()
  "Copy the list of ROAM_ALIASES into HUGO_ALIASES.

Work in progress"
  (interactive)
  (when (org-roam-file-p)
    (when-let*
        ((option
          "HUGO_ALIASES")
         (raw-roam-aliases
          (read (format "(%s)"
                        (org-export-get-node-property
                         :ROAM_ALIASES
                         (org-element-parse-buffer)))))
         (roam-aliases
          (mapcar
           #'downcase
           (mapcar
            (lambda (alias)
              (replace-regexp-in-string
               " "
               "_"
               alias))
            raw-roam-aliases))))
      ;;roam-aliases
      roam-aliases
      )))

;; (cashweaver/org-roam--mirror-roam-aliases-to-hugo-aliases)

(defun cashweaver/org-roam--mirror-roam-aliases-to-hugo-aliases ()
  "Copy the list of ROAM_ALIASES into HUGO_ALIASES."
  (interactive)
  (when (org-roam-file-p)
    (when-let
        ((option
          "HUGO_ALIASES")
         (raw-roam-aliases
          (org-export-get-node-property
            :ROAM_ALIASES
            (org-element-parse-buffer))))
      (message raw-roam-aliases))))

(defun cashweaver/org-roam--process-ref-before-adding-to-front-matter (ref)
  (cond
   ((string-match-p "^\\[cite" ref)
    nil
    ;; (let ((citation
    ;;        (save-excursion
    ;;          (beginning-of-buffer)
    ;;          (search-forward ref)
    ;;          (org-element-citation-parser))))
    ;;   (org-cite-export-citation
    ;;    citation
    ;;    nil
    ;;    '(:cite-export nil)
    ;;    ))
    )
   (t
    ref)))

(defun cashweaver/org-roam-mirror-roam-refs-to-front-matter ()
  "Copy the list of ROAM_REFS into hugo_custom_front_matter."
  (interactive)
  (when (and (org-roam-file-p)
             (not (member
                   (buffer-file-name)
                   cashweaver/org-roam--file-path-exceptions-to-mirror-refs-to-front-matter)))
    (when-let*
        ((keyword
          "HUGO_CUSTOM_FRONT_MATTER")
         (raw-roam-refs
          (org-export-get-node-property
           :ROAM_REFS
           (org-element-parse-buffer)))
         (refs
          (split-string
           raw-roam-refs
           " +"))
         (valid-refs
          (-filter
           (lambda (ref)
             (not (string-match-p "^\\[cite" ref)))
           refs))
         (roam-refs
          (format
           "roam_refs '(%s)"
           (string-join
            (mapcar
             (lambda (ref)
               (format "\"%s\""
                       ref))
             valid-refs)
            " ")))
         (current-roam-refs
          (or
           (org-roam-get-keyword
            keyword)
           "")))
      (if (not (string=
                roam-refs
                current-roam-refs))
          (org-roam-set-keyword
           (downcase keyword)
           roam-refs)))))

(defun cashweaver/citation-present-in-buffer-p ()
  "Return true if a citation is present in the current buffer, nil otherwise."
  (let ((citation-prefix
         "[cite"))
    (save-excursion
      (goto-char
       (point-min))
      (search-forward
       citation-prefix
       ;; bound
       nil
       ;; no-error
       t))))

(defcustom cashweaver/org-roam--file-path-exceptions-to-add-bibliography
  '()
  "File paths which will not have a bibliography added by `cashweaver/org-roam-add-bibliography'.")

(defun cashweaver/org-roam-add-bibliography (&optional skip-if-present)
  "Add #+print_bibiliography to the current buffer."
  (interactive)
  (when (and (org-roam-file-p)
             (not
              (member
               (buffer-file-name)
               cashweaver/org-roam--file-path-exceptions-to-add-bibliography))
             (cashweaver/citation-present-in-buffer-p))
    (let* ((skip-if-present
            (or skip-if-present
                t))
           (bibliography-option
            "#+print_bibliography:")
           (bibliography-present-in-buffer
            (save-excursion
              (goto-char
               (point-min))
              (search-forward
               bibliography-option
               ;; bound
               nil
               ;; noerror
               t))))
      (unless (and skip-if-present
                   bibliography-present-in-buffer)
        (save-excursion
          (goto-char
           (point-min))
          (cond
           ((search-forward
             "Anki :noexport:"
             ;; bound
             nil
             ;; noerror
             t)
            (previous-line)
            (end-of-line)
            (newline))
           (t
            (goto-char
             (point-max))))
          (insert
           bibliography-option))))))

(defcustom cashweaver/org-roam--file-path-exceptions-to-add-anki
  '()
  "File paths which will not have a bibliography added by `cashweaver/org-roam-add-anki'.")

(defun cashweaver/anki-available-p ()
  (condition-case error
      (anki-editor-api-check)
    ('error
     nil))
  t)

(defun cashweaver/enable-anki-editor-mode ()
  (if (cashweaver/anki-available-p)
      (anki-editor-mode t)
    (message "Skipping enable anki-editor-mode because Anki isn't available.")))

(defun cashweaver/anki-editor-push-notes ()
  (if (cashweaver/anki-available-p)
      (anki-editor-push-notes)
    (message "Skipping anki-editor-push-notes because Anki isn't available.")))

(defun cashweaver/org-roam-add-anki (&optional skip-if-present)
  "Add Anki heading to the current buffer."
  (interactive)
  (when (cashweaver/anki-available-p)
    (let ((skip-if-present
           (or skip-if-present
               t))
          (anki-header-regexp
           (rx
            "*"
            (or " TODO"
                "")
            (or (and " \[#"
                     (any "0" "1" "2" "3" "4")
                     "\]")
                "")
            " Anki")
           )
          (is-valid-file
           (and (org-roam-file-p)
                (not
                 (member
                  (buffer-file-name)
                  cashweaver/org-roam--file-path-exceptions-to-add-anki)))))
      (when is-valid-file
        (let* ((anki-present-in-buffer
                (save-excursion
                  (goto-char
                   (point-min))
                  (re-search-forward
                   anki-header-regexp
                   ;; bound
                   nil
                   ;; noerror
                   t))))
          (unless (and skip-if-present
                       anki-present-in-buffer)
            (save-excursion
              (goto-char
               (point-max))
              (org-insert-heading
               ;; arg
               nil
               ;; invisible-ok
               t
               ;; top
               t
               )
              (insert "TODO [#2] Anki")
              (org-set-tags '("noexport"))
              (org-set-property
               "ANKI_DECK"
               "Default"))))))))

(defun run-function-in-file (filepath function &optional arguments)
  (let ((args (or arguments
                  nil)))
    (save-excursion
      (find-file filepath)
      (apply function arguments)
      (write-file filepath)
      (kill-buffer (current-buffer)))))

(defun cashweaver/org-hugo-export-all (directory)
  (mapc (lambda (filepath)
          (run-function-in-file
           filepath
           'cashweaver/org-hugo-export-wim-to-md))
        (directory-files
         directory
         ;; full
         t
         ;; match
         ".org$")))

(defun cashweaver/org-roam-set-filetag ()
  "Set the filetag option based on org-roam tags."
  (interactive)
  (when (org-roam-file-p)
    (let ((node-id (org-roam-node-id
                    (org-roam-node-at-point))))
      (cashweaver/org-roam--set-filetag
       node-id))))

(defun cashweaver/org-roam-insert-tag-link ()
  "Insert a link to the selected tag"
  (interactive)
  (let ((tag
         (completing-read
          "Select tag: "
          (cashweaver/org-roam--get-filetags)
          )))
    (insert
     (format "[[/tags/%s][%s]]"
             (downcase
              (nth 0
                   (org-hugo--tag-processing-fn-replace-with-hyphens-maybe
                    `(,tag)
                    `(:hugo-prefer-hyphen-in-tags ,org-hugo-prefer-hyphen-in-tags))))
             tag))))


(defun cashweaver/org-roam-node-from-cite (keys-entries)
  "Create a roam node based on bibliography citation.

See: https://jethrokuan.github.io/org-roam-guide"
  (interactive (list (citar-select-ref
                      :multiple nil
                      :rebuild-cache t)))
  (let* ((author
          (citar--format-entry-no-widths
           (cdr keys-entries)
           "${author editor journal}"))
         (citation-title
          (citar--format-entry-no-widths
           (cdr keys-entries)
           "${title}"))
         (source-url
          (citar--format-entry-no-widths
           (cdr keys-entries)
           "${howpublished}"))
         (node-title
          (cond
           ((and
             (not (string-empty-p citation-title))
             (not (string-empty-p author)))
            (s-format
             "${author} | ${title}"
             'aget
             `(("author" . ,author)
               ("title" . ,citation-title))))
           ((string-empty-p author)
            citation-title)
           ((string-empty-p citation-title)
            "Something went wrong when extracting the title.")
           (t
            "Something went wrong when parsing the citation."))))

    (org-roam-capture- :templates
                       '(("r" "reference" plain "%?" :if-new
                          (file+head "${citekey}.org"
                                     ":PROPERTIES:
:ROAM_REFS: [cite:@${citekey}]
:END:
,#+title: ${title}\n
,#+author: Cash Weaver\n
,#+date: [%<%Y-%m-%d %a %H:%M>]\n
,#+filetags: :reference:\n
 \n
TODO_AUTHOR, [cite:@${citekey}]\n
 \n
,* TODO Summary\n
,* TODO Thoughts\n
,* TODO Notes\n")
                          :immediate-finish t
                          :unnarrowed t))
                       :info (list :citekey (car keys-entries))
                       :node (org-roam-node-create :title node-title)
                       :props '(:finalize find-file))))

(defun cashweaver/org-roam-before-save ()
  (cashweaver/org-roam-rewrite-smart-to-ascii)
  (cashweaver/org-roam-mirror-roam-refs-to-front-matter)
  (cashweaver/org-roam-add-bibliography)
  (cashweaver/org-roam-add-anki)
  (cashweaver/anki-editor-push-notes))
#+end_src

#+RESULTS:
: cashweaver/org-roam-before-save

#+begin_src emacs-lisp
(cashweaver/org-hugo-export-all
 (format "%s/proj/roam"
         cashweaver/home-dir-path))
#+end_src


***** Roam UI

#+begin_src emacs-lisp :tangle config-personal.el
(use-package! websocket
  :after org-roam)

(use-package! org-roam-ui
  :after org-roam
  ;; normally we'd recommend hooking orui after org-roam, but since org-roam does not have
  ;; a hookable mode anymore, you're advised to pick something yourself
  ;; if you don't care about startup time, use
  ;; :hook (after-init . org-roam-ui-mode)
  :config
  (setq org-roam-ui-sync-theme t
        org-roam-ui-follow t
        org-roam-ui-update-on-save t
        org-roam-ui-open-on-start t))
#+end_src

**** Annotate PDFs

***** TODO Config

#+begin_src emacs-lisp :tangle config-personal.el
(defun cashweaver/org-noter-insert-selected-text-inside-note-content ()
  "Insert selected text in org-noter note.

Reference: https://github.com/weirdNox/org-noter/issues/88#issuecomment-700346146"
  (interactive)
  (progn
    (setq currenb (buffer-name))
    (org-noter-insert-precise-note)
    (set-buffer currenb)
    (org-noter-insert-note)))
#+end_src

*** TODO Citations

#+begin_src emacs-lisp :tangle config-personal.el
(setq
 cashweaver/path--roam-bibliography
 (format "%s/proj/roam/bibliography.bib"
         cashweaver/home-dir-path)
 cashweaver/bibliographies `(,cashweaver/path--roam-bibliography))
#+end_src
**** Config

#+begin_src emacs-lisp :tangle config-personal.el
(use-package! citar
  :when (featurep! :completion vertico)
  :config
  (setq
   citar-bibliography cashweaver/bibliographies)
  (defun cashweaver/citar-full-names (names)
    "Transform names like LastName, FirstName to FirstName LastName.

Reference: https://gist.github.com/bdarcus/a41ffd7070b849e09dfdd34511d1665d"
    (when (stringp names)
      (mapconcat
       (lambda (name)
         (if (eq 1 (length name))
             (split-string name " ")
           (let ((split-name (split-string name ", ")))
             (cl-concatenate 'string (nth 1 split-name) " " (nth 0 split-name)))))
       (split-string names " and ") ", ")))
  (setq citar-display-transform-functions
        '((t . citar-clean-string)
          (("author" "editor") . cashweaver/citar-full-names))))
#+end_src

**** Config

#+begin_src emacs-lisp :tangle config-personal.el
(use-package! oc
  :after org citar
  :config
  (setq
   org-cite-global-bibliography cashweaver/bibliographies
   org-cite-insert-processor 'citar
   org-cite-follow-processor 'citar
   org-cite-activate-processor 'citar))
#+end_src

*** Keybindings

#+begin_src emacs-lisp :tangle config-personal.el
(after! org
  ;; Keep in alphabetical order.
  (map!
   :map org-mode-map
   :localleader
   :nv "@" nil
   (:prefix ("@" . "Citation")
    :n "@" #'org-cite-insert
    :n "r" #'citar-refresh)
   (:prefix ("b")
    :n "RET" #'org-table-copy-down)
   (:prefix ("c")
    :n "E" #'org-clock-modify-effort-estimate
    :n "e" #'org-set-effort)
   (:prefix ("d")
    (:prefix ("h" . "insert heading")
     :n "t" (cmd! (cashweaver/org-mode-insert-heading-for-today
                   ;; top
                   nil
                   ;; time-in-heading
                   nil
                   ;; include-all-tags
                   nil))
     :n "T" (cmd! (cashweaver/org-mode-insert-heading-for-today nil t t))
     :n "w" #'cashweaver/org-mode-insert-heading-for-this-week)
    (:prefix ("S")
     (:prefix ("." . "today")
      :desc "at" :n "a" #'cashweaver/org--schedule-today-at)
     (:prefix ("d" . "day")
      :desc "Monday" :n "m" )
     (:prefix ("h" . "hour")
      (:prefix ("0" . "0?:??")
       :desc "00:00" :n "0" (cmd! (cashweaver/org-schedule-today-from-to "00:00" "00:45"))
       :desc "01:00" :n "1" (cmd! (cashweaver/org-schedule-today-from-to "01:00" "01:45"))
       :desc "02:00" :n "2" (cmd! (cashweaver/org-schedule-today-from-to "02:00" "02:45"))
       :desc "03:00" :n "3" (cmd! (cashweaver/org-schedule-today-from-to "03:00" "03:45"))
       :desc "04:00" :n "4" (cmd! (cashweaver/org-schedule-today-from-to "04:00" "04:45"))
       :desc "05:00" :n "5" (cmd! (cashweaver/org-schedule-today-from-to "05:00" "05:45"))
       :desc "06:00" :n "6" (cmd! (cashweaver/org-schedule-today-from-to "06:00" "06:45"))
       :desc "07:00" :n "7" (cmd! (cashweaver/org-schedule-today-from-to "07:00" "07:45"))
       :desc "08:00" :n "8" (cmd! (cashweaver/org-schedule-today-from-to "08:00" "08:45"))
       :desc "09:00" :n "9" (cmd! (cashweaver/org-schedule-today-from-to "09:00" "09:45")))
      (:prefix ("1" . "1?:??")
       :desc "01:00" :n "RET" (cmd! (cashweaver/org-schedule-today-from-to "01:00" "01:45"))
       :desc "10:00" :n "0" (cmd! (cashweaver/org-schedule-today-from-to "10:00" "10:45"))
       :desc "11:00" :n "1" (cmd! (cashweaver/org-schedule-today-from-to "11:00" "11:45"))
       :desc "12:00" :n "2" (cmd! (cashweaver/org-schedule-today-from-to "12:00" "12:45"))
       :desc "13:00" :n "3" (cmd! (cashweaver/org-schedule-today-from-to "13:00" "13:45"))
       :desc "14:00" :n "4" (cmd! (cashweaver/org-schedule-today-from-to "14:00" "14:45"))
       :desc "15:00" :n "5" (cmd! (cashweaver/org-schedule-today-from-to "15:00" "15:45"))
       :desc "16:00" :n "6" (cmd! (cashweaver/org-schedule-today-from-to "16:00" "16:45"))
       :desc "17:00" :n "7" (cmd! (cashweaver/org-schedule-today-from-to "17:00" "17:45"))
       :desc "18:00" :n "8" (cmd! (cashweaver/org-schedule-today-from-to "18:00" "18:45"))
       :desc "19:00" :n "9" (cmd! (cashweaver/org-schedule-today-from-to "19:00" "19:45")))
      (:prefix ("2" . "2?:??")
       :desc "20:00" :n "0" (cmd! (cashweaver/org-schedule-today-from-to "20:00" "20:45"))
       :desc "21:00" :n "3" (cmd! (cashweaver/org-schedule-today-from-to "21:00" "21:45"))
       :desc "22:00" :n "2" (cmd! (cashweaver/org-schedule-today-from-to "22:00" "22:45"))
       :desc "23:00" :n "3" (cmd! (cashweaver/org-schedule-today-from-to "23:00" "23:45")))
      :desc "03:00" :n "3" (cmd! (cashweaver/org-schedule-today-from-to "03:00" "03:45"))
      :desc "04:00" :n "4" (cmd! (cashweaver/org-schedule-today-from-to "04:00" "04:45"))
      :desc "05:00" :n "5" (cmd! (cashweaver/org-schedule-today-from-to "05:00" "05:45"))
      :desc "06:00" :n "6" (cmd! (cashweaver/org-schedule-today-from-to "06:00" "06:45"))
      :desc "07:00" :n "7" (cmd! (cashweaver/org-schedule-today-from-to "07:00" "07:45"))
      :desc "08:00" :n "8" (cmd! (cashweaver/org-schedule-today-from-to "08:00" "08:45"))
      :desc "09:00" :n "9" (cmd! (cashweaver/org-schedule-today-from-to "09:00" "09:45")))))

   (:prefix ("l")
    (:prefix ("T" . "transclusion")
     :n "a" #'org-transclusion-add
     :n "A" #'org-transclusion-add-all
     :n "i" #'org-transclusion-make-from-link
     :n "l" #'org-transclusion-live-sync-start
     :n "r" #'org-transclusion-remove
     :n "R" #'org-transclusion-remove-all))

   (:prefix ("m" . "org-roam")
    :desc "Open ref" :n "O" #'cashweaver/org-roam-open-ref
    (:prefix ("l" . "link")
     :n "q" #'cashweaver/org-roam-insert-tag-link)
    :desc "Tag" :n "q" (cmd! ()
                             (when (org-roam-file-p)
                               (let ((node-id (org-roam-node-id
                                               (org-roam-node-at-point))))

                                 (cashweaver/org-roam--set-filetag
                                  node-id))))
    ;;#'cashweaver/org-roam--set-filetag
    :desc "Create node from headline link" :n "N" (cmd! ()
                                                        (cashweaver/org-roam-new-node-from-link-heading-at-point
                                                         ;; mark-as-done
                                                         t))
    :desc "Publish all" :n "p" #'cashweaver/org-hugo-export-all)
   (:prefix ("S" . "Structure")
    :n "i" #'org-insert-structure-template)))
#+end_src

#+begin_src emacs-lisp :tangle config-personal.el
(after! org-noter
  (map!
   :map pdf-view-mode-map
   :localleader

   :n "n" #'org-noter-insert-note
   :n "N" #'org-noter-insert-precise-note
   :desc "Quote (precise)" :n "Q" #'cashweaver/org-noter-insert-selected-text-inside-note-content))
#+end_src

*** TODO =org-protocol=

#+begin_src emacs-lisp :tangle config-personal.el
(use-package! org-protocol
  :config
  (setq org-protocol-default-template-key "p"
        org-capture-templates
        '(("p" "Protocol" entry (file+headline "/tmp/notes.org" "Inbox")
           "* %^{Title}\nSource: %u, %c\n #+BEGIN_QUOTE\n%i\n#+END_QUOTE\n\n\n%?")
          ("L" "Protocol Link" entry (file+headline "/tmp/notes.org" "Inbox")
           "* %? [[%:link][%:description]] \nCaptured On: %U")
          ("w" "Web site" entry (file "") "* %a :website:\n\n%U %?\n\n%:initial")
          )))

(use-package! org-protocol-capture-html
  ;; see https://github.com/alphapapa/org-protocol-capture-html for usage
  :after org-protocol)
#+end_src

*** =org-gtasks=

#+begin_src emacs-lisp :tangle config-personal.el
(defun cashweaver/org-gtasks--get-client-secret ()
  "Return client secret for Cash Weaver's Google Tasks."
  (replace-regexp-in-string
   "\n"
   ""
   (with-temp-buffer
     (insert-file-contents
      (file-truename
       "~/.config/org-gtasks/client-secret"))
     (buffer-string))))

;; (use-package! org-gtasks
;;   :after org
;;   :config
;;   (setq
;;    cashweaver/org-gtasks-client-id "TODO"
;;    cashweaver/org-gtasks-client-secret (cashweaver/org-gtasks--get-client-secret)
;;    org-gtasks-accounts '())
;;   (org-gtasks-register-account
;;    :name "People"
;;    :directory "~/proj/people"
;;    :client-id cashweaver/org-gtasks-client-id
;;    :client-secret cashweaver/org-gtasks-client-secret))
#+end_src

*** Contacts

**** =org-vcard=

#+begin_src emacs-lisp :tangle config-personal.el
(use-package! org-vcard)
#+end_src

** TODO Portable Document Format (PDF)
*** Packages
**** =pdf-tools=

***** Package

#+begin_src emacs-lisp :tangle packages-personal.el
(package! pdf-tools)
#+end_src

***** Config

#+begin_src emacs-lisp :tangle config-personal.el
(use-package! pdf-tools)
#+end_src
**** =pdf-tools=
***** Package
DEADLINE: <2021-12-02 Thu 10:00> SCHEDULED: <2021-12-02 Thu>

=pdf-tools= is provided by =init.el=.

***** Config

#+begin_src emacs-lisp :tangle config-personal.el
(use-package! pdf-tools
  :config
  (pdf-tools-install))
#+end_src

** TOML

#+begin_src emacs-lisp :tangle packages-personal.el
(package! toml
  :recipe (:host github
           :repo "gongo/emacs-toml"))
#+end_src

#+begin_src emacs-lisp :tangle config-personal.el
(use-package! toml)
#+end_src

* File Management and Navigation

** =projectile=

*** Known Projects

#+begin_src emacs-lisp :tangle config-personal.el
(defcustom cashweaver/project-path-fns
  '()
  "List of functions which return a list of project paths.")

(defun cashweaver/get-proj-dir-paths (&optional projects-to-exclude proj-dir-path)
  "Return a list of absolute paths to project directories.

Exclude project names listed in PROJECTS-TO-EXCLUDE."
  (let* ((projects-to-exclude
          (or
           projects-to-exclude
           '()))
         (proj-dir-path
          (or
           proj-dir-path
           (format
            "%s/proj"
            cashweaver/home-dir-path)))
         (proj-names
          (remove-if
           (lambda (file-name)
             (or
              (member file-name projects-to-exclude)
              (string= ".." file-name)
              (string= "." file-name)
              (not (f-dir?
                    (expand-file-name
                     file-name
                     proj-dir-path)))))
           (directory-files
            proj-dir-path)))
         (absolute-proj-dir-paths
          (mapcar
           (lambda (proj-name)
             (format "%s/%s"
                     proj-dir-path
                     proj-name))
           proj-names)))
    absolute-proj-dir-paths))

(add-to-list
 'cashweaver/project-path-fns
 'cashweaver/get-proj-dir-paths)
#+end_src

#+begin_src emacs-lisp :tangle config-personal.el
(defvar cashweaver/gdrive-mount-dir-path
  "/mnt/cashbweaver-gdrive"
  "Absoltue path to personal Google Drive mount.")

(defvar cashweaver/gdrive-notes-dir-path
  (format "%s/notes"
          cashweaver/gdrive-mount-dir-path)
  "Absolute path to personal notes directory in Google Drive.")

;; (add-to-list
;;  'cashweaver/project-paths
;;  cashweaver/gdrive-notes-dir-path)
#+end_src

#+begin_src emacs-lisp :tangle config-personal.el
(defun cashweaver/maybe-add-trailing-forward-slash (str)
  "Return STR with a trailing slash (added if it was missing)."
  (if (s-ends-with? "/" str)
      str
    (format "%s/" str)))

(defun cashweaver/get-flattened-known-project-paths ()
  "Return a list of all known project paths"
  (let* ((nested-paths
          (loop for fn in cashweaver/project-path-fns
                collect (funcall fn)))
         (paths
          (mapcar
           (lambda (path)
             (cashweaver/maybe-add-trailing-forward-slash path))
           (flatten-tree
            nested-paths))
          ))
    paths))

(defun cashweaver/projectile-refresh-known-paths ()
  "Refresh the paths which projectile knows about."
  (interactive)
  (projectile-clear-known-projects)
  (setq projectile-known-projects
        (cashweaver/get-flattened-known-project-paths)))

(after! projectile
  (cashweaver/projectile-refresh-known-paths))
#+end_src

* Key bindings
* Wishlist
** TODO [#4] Create roam node from link at point
:PROPERTIES:
:Effort:   2h
:END:
Create a new roam node using the link at point. Pull the title used at the URL under the link; let the user override if they want to. Include the link in the node's refs.

** TODO [#2] See if I can extract anything else from =config-work.org=
** TODO [#4] =s/cashweaver//cashweaver\//= for my methods
:PROPERTIES:
:Effort:   1h
:END:
** TODO [#2] Write about my use of =org-roam=, =hugo=, etc
:PROPERTIES:
:Effort:   4h
:END:

* Bucket

Bits that I haven't yet filed into a larger heading

** INPROGRESS Rewrite "raw" links in buffer into org-mode links

#+begin_src emacs-lisp
;; https ://docs.google.com/document/d/1OqMKeO-XnvD8qK6qH0u_TplZrofVYqG_R4VGeLbAklM/edit #heading=h.hy2rqfrcolct

(setq
 cashweaver/rewrite-links--match--google-sheets "https?://docs.google.com/spreadsheets/d/\\([A-Za-z0-9-_]+\\)"
 cashweaver/rewrite-links-matches `((,cashweaver/rewrite-links--match--google-docs . "google-docs")))

(defun cashweaver/rewrite-links ()
  "Rewrite raw links in the current buffer into org links."
  (interactive)
  (save-excursion
    (goto-char
     (point-min))
    (while
        (search-forward-regexp
         cashweaver/rewrite-links--match--google-sheets
         ;; bound
         nil
         ;; noerror
         t)
      (replace-match
       (cashweaver/org-link--google-sheets-build-org-link
        ;; sheet-id
        (match-string 1)
        ;; description
        "Google Sheet")
       )))

  ;; (let ((link-regexps
  ;;        `(,cashweaver/rewrite-links--match--google-docs)))
  ;;   ())
  )

(cashweaver/rewrite-links)
#+end_src

** Replace selected text in buffer

#+begin_src emacs-lisp :tangle config-personal.el
(defun cashweaver/replace-selection ()
  (interactive)
  (evil-yank (mark) (point) nil ?\")
  (evil-ex (format "%%s/%s/"
                   (evil-get-register ?\"))))
#+end_src

** Reload dir-local variables

#+begin_src emacs-lisp :tangle config-personal.el
(defun cashweaver/reload-dir-locals-for-current-buffer ()
  "reload dir locals for the current buffer"
  (interactive)
  (let ((enable-local-variables :all))
    (hack-dir-local-variables-non-file-buffer)))
#+end_src

** TOML

#+begin_src emacs-lisp :tangle packages-personal.el
(package! toml
  :recipe (:host github
           :repo "gongo/emacs-toml"))
#+end_src

#+begin_src emacs-lisp :tangle config-personal.el
(use-package! toml)
#+end_src

#+begin_src emacs-lisp
;; (yaml-parse-string "
;; title = \"this is the title\"
;; draft = false")
(toml:read-from-string "
title = \"this is the title\"
author = [\"cashweaver\"]
date = 2022-02-10T09:33:00-08:00
draft = true")
#+end_src

** =electric-case=
#+begin_src emacs-lisp :tangle packages-personal.el
(package! electric-case
  :recipe (:host github
           :repo "zk-phi/electric-case"))
#+end_src

#+begin_src emacs-lisp :tangle config-personal.el
(use-package! electric-case)
#+end_src

#+begin_src emacs-lisp :tangle config-personal.el
;; (add-hook!
;;  'java-mode-hook
;;  'electric-case-java-init)
#+end_src

** roam for all

#+begin_src emacs-lisp
(defun cashweaver/current-buffer-contains-string (target)
  (save-excursion
    (save-match-data
      (goto-char (point-min))
      (search-forward target
                      ;; bound
                      nil
                      ;; noerror
                      t))))

(defun cashweaver/org-roam-resolve-failures ()
  (interactive)
  (when (cashweaver/current-buffer-contains-string "ANKI_FAILURE_REASON: Note was not found")
    (org-map-entries
     (lambda ()
       (org-delete-property
        "ANKI_NOTE_ID"))
     "+ANKI_FAILURE_REASON={Note was not found.*}")))


(defun cashweaver/org-roam-push-anki-notes ()
  (interactive)
  (let* ((org-hugo-auto-set-lastmod nil)
         (org-roam-directory cashweaver/roam-dir-path)
         (org-roam-files (split-string
                          (shell-command-to-string
                           (s-lex-format
                            "cd ${org-roam-directory}; grep -rl \":ANKI_DECK:\""))))
         (progress-reporter (make-progress-reporter "Pushing anki notes"
                                                    0
                                                    (length org-roam-files)))
         (i 0))
    (org-hugo-auto-export-mode)
    (mapcar
     (lambda (file)
       (org-roam-with-file file nil
         (let ((inhibit-message t))
           ;; (anki-editor-push-notes)
           ;; (cashweaver/org-roam-resolve-failures)
           (anki-editor-push-notes)
           (save-buffer))
         (progress-reporter-update progress-reporter
                                   i)

         (setq
          i (+ i 1))))
     org-roam-files)
    (progress-reporter-done progress-reporter)))

#+end_src

#+RESULTS:
: cashweaver/org-roam-push-anki-notes

** Roam: export all

#+begin_src emacs-lisp
(defun cashweaver/org-roam-export-hugo ()
  (interactive)
  (let* ((org-hugo-auto-set-lastmod nil)
         (org-roam-directory cashweaver/roam-dir-path)
         (org-roam-files (org-roam-list-files))
         (count-org-roam-files (length org-roam-files))
         (progress-reporter (make-progress-reporter "Exporting roam notes"
                                                    0
                                                    (length org-roam-files)))
         (expected-seconds-per-file 1.43
                                    ;; Determined by timing the export of 100 files.
                                    )
         (expected-total-run-time (seconds-to-string (* expected-seconds-per-file
                                                        count-org-roam-files)))
         (prompt (s-lex-format "${count-org-roam-files} found. Export expected to take ${expected-total-run-time}. Continue? "))
         (should-export (y-or-n-p prompt))
         (i 0))
    (when should-export
      ;; Enable hugo auto-export mode
      (org-hugo-auto-export-mode)
      ;; Disable anki-editor-mode
      (anki-editor-mode t)
      (mapcar
       (lambda (file)
         (org-roam-with-file file nil
           (let ((inhibit-message t))
             (goto-char
              (point-max))
             (newline)
             (save-buffer))
           (progress-reporter-update progress-reporter
                                     i)
           (setq
            i (+ i 1))))
       org-roam-files)
      (progress-reporter-done progress-reporter))))
#+end_src

#+RESULTS:
: cashweaver/org-roam-export-hugo

* Footnotes

[fn:1] [[github:zzamboni/dot-doom/blob/master/doom.org][Diego Zamboni]], [[https://sachachua.com/dotemacs/][Sacha Chua]], [[https://tecosaur.github.io/emacs-config/config.html][tecosaur]]
